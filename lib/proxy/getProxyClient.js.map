{"version":3,"sources":["lib/proxy/getProxyClient.js"],"names":["getProxyClient","Target","transport","options","actionTypes","_id","v4","_target","getState","state","target","getProxyState","proxy","_transport","_setTransport","subModule","Object","prototype","hasOwnProperty","configurable","enumerable","get","_reducer","targetReducer","reducer","proxyReducer","types","_proxyActionTypes","_suppressInit","request","payload","type","sync","result","store","dispatch","_syncPromise","_sync","initializeProxy","_proxyInitialized","_initialize","on","events","push","action","actionNumber"],"mappings":"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","file":"getProxyClient.js","sourcesContent":["import uuid from 'uuid';\r\nimport RcModule from '../RcModule';\r\nimport getProxyClientReducer from './getProxyClientReducer';\r\nimport baseActionTypes from './baseActionTypes';\r\nimport ensureExist from '../ensureExist';\r\n\r\n\r\nexport default function getProxyClient(Target) {\r\n  return class extends RcModule {\r\n    constructor({ transport, ...options }) {\r\n      super({\r\n        ...options,\r\n        actionTypes: baseActionTypes,\r\n      });\r\n      this._id = uuid.v4();\r\n      this._target = new Target({\r\n        ...options,\r\n        getState: () => this.state.target,\r\n        getProxyState: () => this.state.proxy,\r\n      });\r\n      this._transport = this::ensureExist(transport, 'transport');\r\n      this._setTransport(this._target);\r\n      for (const subModule in this._target) {\r\n        if (\r\n          this._target::Object.prototype.hasOwnProperty(subModule) &&\r\n            this._target[subModule] instanceof RcModule\r\n        ) {\r\n          Object.defineProperty(this, subModule, {\r\n            configurable: false,\r\n            enumerable: true,\r\n            get() {\r\n              return this._target[subModule];\r\n            },\r\n          });\r\n        }\r\n      }\r\n\r\n      this._reducer = getProxyClientReducer({\r\n        targetReducer: this._target.reducer,\r\n        proxyReducer: this._target.proxyReducer,\r\n        transport,\r\n        types: this.actionTypes,\r\n      });\r\n    }\r\n\r\n    _setTransport(target) {\r\n      target._transport = this._transport;\r\n      target._proxyActionTypes = this.actionTypes;\r\n      target._suppressInit = true;\r\n      for (const subModule in target) {\r\n        if (\r\n          target::Object.prototype.hasOwnProperty(subModule) &&\r\n            target[subModule] instanceof RcModule\r\n        ) {\r\n          this._setTransport(target[subModule]);\r\n        }\r\n      }\r\n    }\r\n\r\n\r\n    async _sync() {\r\n      const result = await this._transport.request({\r\n        payload: {\r\n          type: this.actionTypes.sync,\r\n        },\r\n      });\r\n      this.store.dispatch({\r\n        ...result,\r\n        type: this.actionTypes.sync,\r\n      });\r\n      this._syncPromise = null;\r\n    }\r\n    sync() {\r\n      if (!this._syncPromise) {\r\n        this._syncPromise = this._sync();\r\n      }\r\n      return this._syncPromise;\r\n    }\r\n\r\n    _initialize(target) {\r\n      if (\r\n        typeof target.initializeProxy === 'function' &&\r\n        !target._proxyInitialized\r\n      ) {\r\n        target._proxyInitialized = true;\r\n        target.initializeProxy();\r\n      }\r\n      for (const subModule in target) {\r\n        if (\r\n          target::Object.prototype.hasOwnProperty(subModule) &&\r\n            target[subModule] instanceof RcModule\r\n        ) {\r\n          this._initialize(target[subModule]);\r\n        }\r\n      }\r\n    }\r\n    async initialize() {\r\n      this._transport.on(this._transport.events.push, async (payload) => {\r\n        if (payload.type === this.actionTypes.action) {\r\n          if (this._syncPromise) await this._syncPromise;\r\n          if (payload.actionNumber === this.state.actionNumber + 1) {\r\n            this.store.dispatch({\r\n              ...payload,\r\n              type: this.actionTypes.action,\r\n            });\r\n          } else {\r\n            await this.sync();\r\n          }\r\n        }\r\n      });\r\n      await this.sync();\r\n      this._initialize(this._target);\r\n    }\r\n  };\r\n}\r\n"]}