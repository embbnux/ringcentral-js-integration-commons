{"version":3,"sources":["lib/DataFetcher/index.js"],"names":["DEFAULT_TTL","DEFAULT_RETRY","DataFetcher","auth","client","storage","subscription","tabManager","timeToRetry","ttl","polling","name","actionTypes","enumMap","prefix","getReducer","getDataReducer","getTimestampReducer","dataStorageKey","timestampStorageKey","fetchFunction","subscriptionFilters","subscriptionHandler","readyCheckFn","options","Error","_onStateChange","_auth","loggedIn","_storage","ready","_readyCheckFn","_subscription","status","pending","store","dispatch","type","init","_tabManager","active","isFreshLogin","timestamp","Date","now","fetchData","console","error","_polling","_startPolling","_retry","_subscriptionFilters","subscribe","initSuccess","_clearTimeout","_promise","resetSuccess","_subscriptionHandler","message","_lastMessage","_client","_ttl","_timeToRetry","_fetchFunction","_dataStorageKey","_timestampStorageKey","_reducer","registerReducer","key","reducer","data","fetch","ownerId","fetchSuccess","fetchError","_fetchData","getItem","state"],"mappings":"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","file":"index.js","sourcesContent":["import Pollable from '../Pollable';\nimport { prefixEnum } from '../Enum';\nimport getDataFetcherReducer, {\n  getDefaultDataReducer,\n  getDefaultTimestampReducer,\n} from './getDataFetcherReducer';\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport baseActionTypes from './baseActionTypes';\n\nconst DEFAULT_TTL = 30 * 60 * 1000;\nconst DEFAULT_RETRY = 62 * 1000;\n\nexport default class DataFetcher extends Pollable {\n  constructor({\n    auth,\n    client,\n    storage,\n    subscription,\n    tabManager,\n    timeToRetry = DEFAULT_RETRY,\n    ttl = DEFAULT_TTL,\n    polling = false,\n    name,\n    actionTypes = prefixEnum({ enumMap: baseActionTypes, prefix: name }),\n    getReducer = getDataFetcherReducer,\n    getDataReducer = getDefaultDataReducer,\n    getTimestampReducer = getDefaultTimestampReducer,\n    dataStorageKey = `${name}Data`,\n    timestampStorageKey = `${name}Timestamp`,\n    fetchFunction,\n    subscriptionFilters,\n    subscriptionHandler,\n    readyCheckFn,\n    ...options\n  }) {\n    if (!name) {\n      throw new Error('name must be defined');\n    }\n    if (typeof fetchFunction !== 'function') {\n      throw new Error('fetchFunction must be a asynchronous function');\n    }\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._auth = auth;\n    this._storage = storage;\n    this._client = client;\n    this._subscription = subscription;\n    this._tabManager = tabManager;\n    this._ttl = ttl;\n    this._timeToRetry = timeToRetry;\n    this._polling = polling;\n    this._fetchFunction = fetchFunction;\n    this._subscriptionFilters = subscriptionFilters;\n    this._subscriptionHandler = subscriptionHandler;\n    this._readyCheckFn = readyCheckFn;\n\n    this._dataStorageKey = dataStorageKey;\n    this._timestampStorageKey = timestampStorageKey;\n\n    if (this._storage) {\n      this._reducer = getReducer(this.actionTypes);\n\n      this._storage.registerReducer({\n        key: this._dataStorageKey,\n        reducer: getDataReducer(this.actionTypes),\n      });\n      this._storage.registerReducer({\n        key: this._timestampStorageKey,\n        reducer: getTimestampReducer(this.actionTypes),\n      });\n    } else {\n      this._reducer = getReducer(this.actionTypes, {\n        timestamp: getTimestampReducer(this.actionTypes),\n        data: getDataReducer(this.actionTypes),\n      });\n    }\n\n    this._promise = null;\n    this._lastMessage = null;\n  }\n  _onStateChange = async () => {\n    if (\n      this._auth.loggedIn &&\n      (!this._storage || this._storage.ready) &&\n      (!this._readyCheckFn || this._readyCheckFn()) &&\n      (!this._subscription || this._subscription.ready) &&\n      this.status === moduleStatuses.pending\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.init,\n      });\n      if (\n        (!this._tabManager || this._tabManager.active) &&\n        (\n          this._auth.isFreshLogin ||\n          !this.timestamp ||\n          Date.now() - this.timestamp > this.ttl\n        )\n      ) {\n        try {\n          await this.fetchData();\n        } catch (e) {\n          console.error('fetchData error:', e);\n        }\n      } else if (this._polling) {\n        this._startPolling();\n      } else {\n        this._retry();\n      }\n      if (this._subscription && this._subscriptionFilters) {\n        this._subscription.subscribe(this._subscriptionFilters);\n      }\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    } else if (\n      (\n        !this._auth.loggedIn ||\n        (this._storage && !this._storage.ready) ||\n        (this._readyCheckFn && !this._readyCheckFn()) ||\n        (this._subscription && !this._subscription.ready)\n      ) &&\n      this.ready\n    ) {\n      this._clearTimeout();\n      this._promise = null;\n      this.store.dispatch({\n        type: this.actionTypes.resetSuccess,\n      });\n    } else if (\n      this.ready &&\n      this._subscription &&\n      this._subscription.ready &&\n      this._subscriptionHandler &&\n      this._subscription.message &&\n      this._subscription.message !== this._lastMessage\n    ) {\n      this._lastMessage = this._subscription.message;\n      this._subscriptionHandler(this._lastMessage);\n    }\n  }\n  initialize() {\n    this.store.subscribe(this._onStateChange);\n  }\n\n  get data() {\n    return this._storage ?\n      this._storage.getItem(this._dataStorageKey) :\n      this.state.data;\n  }\n\n  get timestamp() {\n    return this._storage ?\n      this._storage.getItem(this._timestampStorageKey) :\n      this.state.timestamp;\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatuses.ready;\n  }\n\n  get ttl() {\n    return this._ttl;\n  }\n\n  get timeToRetry() {\n    return this._timeToRetry;\n  }\n\n  async _fetchData() {\n    this.store.dispatch({\n      type: this.actionTypes.fetch,\n    });\n    const ownerId = this._auth.ownerId;\n    try {\n      const data = await this._fetchFunction();\n      if (this._auth.ownerId === ownerId) {\n        this.store.dispatch({\n          type: this.actionTypes.fetchSuccess,\n          data,\n          timestamp: Date.now(),\n        });\n        if (this._polling) {\n          this._startPolling();\n        }\n        this._promise = null;\n      }\n    } catch (error) {\n      if (this._auth.ownerId === ownerId) {\n        this._promise = null;\n        this.store.dispatch({\n          type: this.actionTypes.fetchError,\n          error,\n        });\n        if (this._polling) {\n          this._startPolling(this.timeToRetry);\n        } else {\n          this._retry();\n        }\n        throw error;\n      }\n    }\n  }\n  fetchData() {\n    if (!this._promise) {\n      this._promise = this._fetchData();\n    }\n    return this._promise;\n  }\n}\n"]}