{"version":3,"sources":["modules/Environment/index.js"],"names":["Environment","client","globalStorage","sdkConfig","options","actionTypes","_client","_globalStorage","_sdkConfig","_reducer","_serverStorageKey","_enabledStorageKey","registerReducer","key","reducer","types","defaultServer","server","sandbox","store","subscribe","_onStateChange","_shouldInit","_initClientService","dispatch","type","initSuccess","ready","enabled","service","newConfig","environmentChanged","_changeEnvironment","setData","state","status","getItem","changed"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;AAKA;;;;IAIqBA,W;;;AACnB,6BAKG;AAAA,QAJDC,MAIC,QAJDA,MAIC;AAAA,QAHDC,aAGC,QAHDA,aAGC;AAAA,QAFDC,SAEC,QAFDA,SAEC;AAAA,QADEC,OACF;AAAA;;AAAA,2KAEIA,OAFJ;AAGCC;AAHD;;AAKD,UAAKC,OAAL,GAAeL,MAAf;AACA,UAAKM,cAAL,GAAsBL,aAAtB;AACA,UAAKM,UAAL,GAAkBL,SAAlB;AACA,UAAKM,QAAL,GAAgB,qCAAsB,MAAKJ,WAA3B,CAAhB;AACA,UAAKK,iBAAL,GAAyB,mBAAzB;AACA,UAAKC,kBAAL,GAA0B,oBAA1B;AACA,UAAKJ,cAAL,CAAoBK,eAApB,CAAoC;AAClCC,WAAK,MAAKH,iBADwB;AAElCI,eAAS,6CAAiB;AACxBC,eAAO,MAAKV,WADY;AAExBW,uBAAe,sBAAIC,MAAJ,CAAWC;AAFF,OAAjB;AAFyB,KAApC;AAOA,UAAKX,cAAL,CAAoBK,eAApB,CAAoC;AAClCC,WAAK,MAAKF,kBADwB;AAElCG,eAAS,8CAAkB,MAAKT,WAAvB;AAFyB,KAApC;AAlBC;AAsBF;;;;iCACY;AAAA;;AACX,WAAKc,KAAL,CAAWC,SAAX,CAAqB;AAAA,eAAM,OAAKC,cAAL,EAAN;AAAA,OAArB;AACD;;;qCACgB;AACf,UAAI,KAAKC,WAAL,EAAJ,EAAwB;AACtB,aAAKC,kBAAL;AACA,aAAKJ,KAAL,CAAWK,QAAX,CAAoB;AAClBC,gBAAM,KAAKpB,WAAL,CAAiBqB;AADL,SAApB;AAGD;AACF;;;kCACa;AACZ,aAAO,KAAKnB,cAAL,CAAoBoB,KAApB,IAA6B,CAAC,KAAKA,KAA1C;AACD;;;yCACoB;AACnB,UAAI,KAAKC,OAAT,EAAkB;AAChB,aAAKtB,OAAL,CAAauB,OAAb,GAAuB,qDAClB,KAAKrB,UADa;AAErBS,kBAAQ,KAAKA;AAFQ,WAAvB;AAID;AACF;;;uCACkBW,O,EAASX,M,EAAQ;AAClC,UAAMa,uCACD,KAAKtB,UADJ,CAAN;AAGA,UAAIoB,OAAJ,EAAa;AACXE,kBAAUb,MAAV,GAAmBA,MAAnB;AACD;AACD,WAAKX,OAAL,CAAauB,OAAb,GAAuB,0BAAQC,SAAR,CAAvB;AACD;;;mCAE4B;AAAA,UAAnBb,MAAmB,SAAnBA,MAAmB;AAAA,UAAXW,OAAW,SAAXA,OAAW;;AAC3B,UAAMG,qBACJ,KAAKH,OAAL,KAAiBA,OAAjB,IACCA,WAAW,KAAKX,MAAL,KAAgBA,MAF9B;AAGA,UAAIc,kBAAJ,EAAwB;AACtB,aAAKC,kBAAL,CAAwBJ,OAAxB,EAAiCX,MAAjC;AACD;AACD,WAAKE,KAAL,CAAWK,QAAX,CAAoB;AAClBC,cAAM,KAAKpB,WAAL,CAAiB4B,OADL;AAElBhB,sBAFkB;AAGlBW,wBAHkB;AAIlBG;AAJkB,OAApB;AAMD;;;wBACY;AACX,aAAO,KAAKG,KAAL,CAAWC,MAAlB;AACD;;;wBAEW;AACV,aAAO,KAAKD,KAAL,CAAWC,MAAX,KAAsB,uBAAaR,KAA1C;AACD;;;wBAEY;AACX,aAAO,KAAKpB,cAAL,CAAoB6B,OAApB,CAA4B,KAAK1B,iBAAjC,CAAP;AACD;;;wBAEa;AACZ,aAAO,KAAKH,cAAL,CAAoB6B,OAApB,CAA4B,KAAKzB,kBAAjC,CAAP;AACD;;;wBAEa;AACZ,aAAO,KAAKuB,KAAL,CAAWG,OAAlB;AACD;;;;;kBA7FkBrC,W","file":"index.js","sourcesContent":["import SDK from 'ringcentral';\nimport RcModule from '../../lib/RcModule';\nimport moduleStatus from '../../enums/moduleStatus';\nimport actionTypes from './actionTypes';\nimport getEnvironmentReducer, {\n  getServerReducer,\n  getEnabledReducer,\n} from './getEnvironmentReducer';\n\n/**\n * @class\n * @description Environment module manages which api server the app calls.\n */\nexport default class Environment extends RcModule {\n  constructor({\n    client,\n    globalStorage,\n    sdkConfig,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._client = client;\n    this._globalStorage = globalStorage;\n    this._sdkConfig = sdkConfig;\n    this._reducer = getEnvironmentReducer(this.actionTypes);\n    this._serverStorageKey = 'environmentServer';\n    this._enabledStorageKey = 'environmentEnabled';\n    this._globalStorage.registerReducer({\n      key: this._serverStorageKey,\n      reducer: getServerReducer({\n        types: this.actionTypes,\n        defaultServer: SDK.server.sandbox,\n      }),\n    });\n    this._globalStorage.registerReducer({\n      key: this._enabledStorageKey,\n      reducer: getEnabledReducer(this.actionTypes),\n    });\n  }\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n  _onStateChange() {\n    if (this._shouldInit()) {\n      this._initClientService();\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    }\n  }\n  _shouldInit() {\n    return this._globalStorage.ready && !this.ready;\n  }\n  _initClientService() {\n    if (this.enabled) {\n      this._client.service = new SDK({\n        ...this._sdkConfig,\n        server: this.server,\n      });\n    }\n  }\n  _changeEnvironment(enabled, server) {\n    const newConfig = {\n      ...this._sdkConfig,\n    };\n    if (enabled) {\n      newConfig.server = server;\n    }\n    this._client.service = new SDK(newConfig);\n  }\n\n  setData({ server, enabled }) {\n    const environmentChanged =\n      this.enabled !== enabled ||\n      (enabled && this.server !== server);\n    if (environmentChanged) {\n      this._changeEnvironment(enabled, server);\n    }\n    this.store.dispatch({\n      type: this.actionTypes.setData,\n      server,\n      enabled,\n      environmentChanged,\n    });\n  }\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatus.ready;\n  }\n\n  get server() {\n    return this._globalStorage.getItem(this._serverStorageKey);\n  }\n\n  get enabled() {\n    return this._globalStorage.getItem(this._enabledStorageKey);\n  }\n\n  get changed() {\n    return this.state.changed;\n  }\n}\n"]}