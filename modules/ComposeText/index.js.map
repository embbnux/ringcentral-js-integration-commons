{"version":3,"sources":["modules/ComposeText/index.js"],"names":["ComposeText","alert","auth","storage","messageSender","numberValidate","options","actionTypes","_alert","_auth","_storage","_storageKey","_reducer","_cacheReducer","_messageSender","_numberValidate","registerReducer","key","reducer","store","subscribe","_onStateChange","_shouldInit","dispatch","type","initSuccess","isFreshLogin","clean","_initSenderNumber","_shouldReset","_resetModuleStatus","ready","resetSuccess","defaultPhoneNumber","cachedPhoneNumber","cache","senderNumber","senderNumbersList","updateSenderNumber","message","warning","phoneNumber","validateResult","validateFormat","result","error","errors","_alertWarning","recipientNumberInvalids","text","messageText","fromNumber","toNumbers","map","number","typingToNumber","_validatePhoneNumber","push","send","length","updateTypingToNumber","cleanTypingToNumber","addToNumber","removeToNumber","textTooLong","updateMessageText","getItem","state","status"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from '../../lib/RcModule';\nimport isBlank from '../../lib/isBlank';\nimport moduleStatuses from '../../enums/moduleStatuses';\n\nimport composeTextActionTypes from './composeTextActionTypes';\nimport getComposeTextReducer from './getComposeTextReducer';\nimport getCacheReducer from './getCacheReducer';\n\nimport messageSenderMessages from '../MessageSender/messageSenderMessages';\nimport proxify from '../../lib/proxy/proxify';\n\nexport default class ComposeText extends RcModule {\n  constructor({\n    alert,\n    auth,\n    storage,\n    messageSender,\n    numberValidate,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes: composeTextActionTypes,\n    });\n\n    this._alert = alert;\n    this._auth = auth;\n    this._storage = storage;\n    this._storageKey = 'composeText';\n    this._reducer = getComposeTextReducer(this.actionTypes);\n    this._cacheReducer = getCacheReducer(this.actionTypes);\n    this._messageSender = messageSender;\n    this._numberValidate = numberValidate;\n    storage.registerReducer({ key: this._storageKey, reducer: this._cacheReducer });\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  _onStateChange() {\n    if (\n      this._shouldInit()\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n      if (this._auth.isFreshLogin) {\n        this.clean();\n      }\n      this._initSenderNumber();\n    } else if (\n      this._shouldReset()\n    ) {\n      this._resetModuleStatus();\n    }\n  }\n\n  _shouldInit() {\n    return (\n      this._messageSender.ready &&\n      this._auth.ready &&\n      !this.ready\n    );\n  }\n\n  _shouldReset() {\n    return (\n      (\n        !this._messageSender.ready\n      ) &&\n      this.ready\n    );\n  }\n\n  _resetModuleStatus() {\n    this.store.dispatch({\n      type: this.actionTypes.resetSuccess,\n    });\n  }\n\n  _initSenderNumber() {\n    let defaultPhoneNumber = null;\n    const cachedPhoneNumber = this.cache && this.cache.senderNumber;\n    if (cachedPhoneNumber) {\n      defaultPhoneNumber = cachedPhoneNumber;\n    } else {\n      defaultPhoneNumber = this._messageSender.senderNumbersList[0];\n    }\n    this.updateSenderNumber(defaultPhoneNumber);\n  }\n\n  _alertWarning(message) {\n    if (message) {\n      this._alert.warning({\n        message,\n      });\n      return true;\n    }\n    return false;\n  }\n\n  _validatePhoneNumber(phoneNumber) {\n    const validateResult = this._numberValidate.validateFormat([phoneNumber]);\n    if (!validateResult.result) {\n      const error = validateResult.errors[0];\n      if (error && this._alertWarning(messageSenderMessages[error.type])) {\n        return false;\n      }\n      this._alertWarning(messageSenderMessages.recipientNumberInvalids);\n      return false;\n    }\n    return true;\n  }\n\n  @proxify\n  async send() {\n    const text = this.messageText;\n    const fromNumber = this.senderNumber;\n    const toNumbers = this.toNumbers.map(number => number.phoneNumber);\n    const typingToNumber = this.typingToNumber;\n    if (!isBlank(typingToNumber)) {\n      if (this._validatePhoneNumber(typingToNumber)) {\n        toNumbers.push(typingToNumber);\n      } else {\n        return null;\n      }\n    }\n    return this._messageSender.send({ fromNumber, toNumbers, text });\n  }\n\n  @proxify\n  async updateSenderNumber(number) {\n    this.store.dispatch({\n      type: this.actionTypes.updateSenderNumber,\n      number: (number || ''),\n    });\n  }\n\n  @proxify\n  async updateTypingToNumber(number) {\n    if (number.length > 30) {\n      this._alertWarning(messageSenderMessages.recipientNumberInvalids);\n      return;\n    }\n    this.store.dispatch({\n      type: this.actionTypes.updateTypingToNumber,\n      number,\n    });\n  }\n\n  @proxify\n  async cleanTypingToNumber() {\n    this.store.dispatch({\n      type: this.actionTypes.cleanTypingToNumber,\n    });\n  }\n\n  @proxify\n  async addToNumber(number) {\n    if (isBlank(number.phoneNumber)) {\n      return;\n    }\n    if (!this._validatePhoneNumber(number.phoneNumber)) {\n      return;\n    }\n    this.store.dispatch({\n      type: this.actionTypes.addToNumber,\n      number,\n    });\n  }\n\n  @proxify\n  async removeToNumber(number) {\n    this.store.dispatch({\n      type: this.actionTypes.removeToNumber,\n      number,\n    });\n  }\n\n  @proxify\n  async updateMessageText(text) {\n    if (text.length > 1000) {\n      this._alertWarning(messageSenderMessages.textTooLong);\n      return;\n    }\n    this.store.dispatch({\n      type: this.actionTypes.updateMessageText,\n      text,\n    });\n  }\n\n  @proxify\n  async clean() {\n    this.store.dispatch({\n      type: this.actionTypes.clean,\n    });\n  }\n\n  get cache() {\n    return this._storage.getItem(this._storageKey);\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.status === moduleStatuses.ready;\n  }\n\n  get senderNumber() {\n    return this.state.senderNumber;\n  }\n\n  get typingToNumber() {\n    return this.state.typingToNumber;\n  }\n\n  get toNumbers() {\n    return this.state.toNumbers;\n  }\n\n  get messageText() {\n    return this.state.messageText;\n  }\n}\n"]}