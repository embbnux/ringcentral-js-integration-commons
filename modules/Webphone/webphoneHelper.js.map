{"version":3,"sources":["modules/Webphone/webphoneHelper.js"],"names":["isBrowerSupport","normalizeSession","patchUserAgent","patchIncomingSession","isChrome","navigator","userAgent","match","chromeVersion","parseInt","session","id","direction","callStatus","to","request","uri","user","toUserName","displayName","from","fromUserName","startTime","Date","getTime","creationTime","isOnHold","local","isOnMute","isOnFlip","isOnTransfer","recordStatus","idle","contactMatch","minimized","createRcMessage","options","body","msgBody","sid","cmd","sipInfo","authorizationId","sendMessage","messageData","sipOptions","contentType","extraHeaders","push","contact","resolve","reject","message","once","response","cause","Error","onMessage","e","data","String","fromCharCode","apply","Uint8Array","error","_onMessage","re","RegExp","ua","configuration","viaHost","newData","replace","Object","defineProperty","value","writable","transport","parseRcHeader","prc","headers","length","rawInviteMsg","raw","parser","DOMParser","xmlDoc","parseFromString","hdrNode","getElementsByTagName","rcHeaders","getAttribute","canUseRCMCallControl","createSessionMessage","undefined","opts","sendSessionMessage","sendReceiveConfirm","toVoiceMail","replyWithMessage","replyOptions","replyType","replyText","timeValue","timeUnits","callbackDirection","console"],"mappings":"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","file":"webphoneHelper.js","sourcesContent":["import recordStatus from './recordStatus';\n\nexport function isBrowerSupport() {\n  const isChrome = !!(navigator.userAgent.match(/Chrom(e|ium)/));\n  if (!isChrome) {\n    return false;\n  }\n  const chromeVersion =\n    parseInt(navigator.userAgent.match(/Chrom(e|ium)\\/([0-9]+)\\./)[2], 10);\n  if (chromeVersion >= 51) {\n    return true;\n  }\n  return false;\n}\n\nexport function normalizeSession(session) {\n  return {\n    id: session.id,\n    direction: session.direction,\n    callStatus: session.callStatus,\n    to: session.request.to.uri.user,\n    toUserName: session.request.to.displayName,\n    from: session.request.from.uri.user,\n    fromUserName: session.request.from.displayName,\n    startTime: (new Date(session.startTime)).getTime(),\n    creationTime: session.creationTime,\n    isOnHold: !!session.isOnHold().local,\n    isOnMute: !!session.isOnMute,\n    isOnFlip: !!session.isOnFlip,\n    isOnTransfer: !!session.isOnTransfer,\n    recordStatus: session.recordStatus || recordStatus.idle,\n    contactMatch: session.contactMatch,\n    minimized: !!session.minimized,\n  };\n}\n\nfunction createRcMessage(options) {\n  options.body = options.body || '';\n  const msgBody = `<Msg><Hdr SID=\"${options.sid}\" Req=\"${options.request}\" From=\"${options.from}\" To=\"${options.to}\" Cmd=\"${options.cmd}\"/> <Bdy Cln=\"${this.sipInfo.authorizationId}\" ${options.body}/></Msg>`;\n  return msgBody;\n}\n\nfunction sendMessage(to, messageData) {\n  const userAgent = this;\n  const sipOptions = {};\n  sipOptions.contentType = 'x-rc/agent';\n  sipOptions.extraHeaders = [];\n  sipOptions.extraHeaders.push(`P-rc-ws: ${this.contact}`);\n\n  return new Promise((resolve, reject) => {\n    const message = userAgent.message(to, messageData, sipOptions);\n\n    message.once('accepted', () => {\n      resolve();\n    });\n    message.once('failed', (response, cause) => {\n      reject(new Error(cause));\n    });\n  });\n}\n\nfunction onMessage(e) {\n  let data = e.data;\n\n  // WebSocket binary message.\n  if (typeof data !== 'string') {\n    try {\n      data = String.fromCharCode.apply(null, new Uint8Array(data));\n    } catch (error) {\n      return this._onMessage.apply(this, [e]);\n    }\n  }\n\n  if (data.match(/CSeq:\\s*\\d+\\s+MESSAGE/i)) {\n    const re = new RegExp(`${this.ua.configuration.viaHost}:\\\\d+`, 'g');\n    const newData = e.data.replace(re, this.ua.configuration.viaHost);\n    Object.defineProperty(e, 'data', {\n      value: newData,\n      writable: false\n    });\n  }\n\n  return this._onMessage.apply(this, [e]);\n}\n\nexport function patchUserAgent(userAgent) {\n  userAgent.createRcMessage = createRcMessage;\n  userAgent.sendMessage = sendMessage;\n  userAgent.transport._onMessage = userAgent.transport.onMessage;\n  userAgent.transport.onMessage = onMessage;\n}\n\n// parse RC headers\nfunction parseRcHeader(session) {\n  const prc = session.request.headers['P-Rc'];\n  if (prc && prc.length) {\n    const rawInviteMsg = prc[0].raw;\n    const parser = new DOMParser();\n    const xmlDoc = parser.parseFromString(rawInviteMsg, 'text/xml');\n    const hdrNode = xmlDoc.getElementsByTagName('Hdr')[0];\n\n    if (hdrNode) {\n      session.rcHeaders = {\n        sid: hdrNode.getAttribute('SID'),\n        request: hdrNode.getAttribute('Req'),\n        from: hdrNode.getAttribute('From'),\n        to: hdrNode.getAttribute('To'),\n      };\n    }\n  }\n}\n\nfunction canUseRCMCallControl() {\n  return !!this.rcHeaders;\n}\n\nfunction createSessionMessage(options) {\n  if (!this.rcHeaders) {\n    return undefined;\n  }\n\n  const opts = {\n    ...options,\n    sid: this.rcHeaders.sid,\n    request: this.rcHeaders.request,\n    from: this.rcHeaders.to,\n    to: this.rcHeaders.from\n  };\n\n  return this.ua.createRcMessage(opts);\n}\n\nfunction sendSessionMessage(options) {\n  if (!this.rcHeaders) {\n    return Promise.reject(new Error('Can\\'t send SIP MESSAGE related to session: no RC headers available'));\n  }\n\n  const to = this.rcHeaders.from;\n\n  return this.ua.sendMessage(to, this.createSessionMessage(options));\n}\n\nfunction sendReceiveConfirm() {\n  return this.sendSessionMessage({ cmd: 17 });\n}\n\nfunction toVoiceMail() {\n  return this.sendSessionMessage({ cmd: 11 });\n}\n\nfunction replyWithMessage(replyOptions) {\n  let body = `RepTp=\"${replyOptions.replyType}\"`;\n\n  if (replyOptions.replyType === 0) {\n    body = `${body} Bdy=\"${replyOptions.replyText}\"`;\n  } else if (replyOptions.replyType === 1) {\n    body = `${body} Vl=\"${replyOptions.timeValue}\"`;\n    body = `${body} Units=\"${replyOptions.timeUnits}\"`;\n    body = `${body} Dir=\"${replyOptions.callbackDirection}\"`;\n  }\n\n  return this.sendSessionMessage({ cmd: 14, body });\n}\n\nexport function patchIncomingSession(session) {\n  try {\n    parseRcHeader(session);\n  } catch (e) {\n    console.error('RC_Phone: Can\\'t parse RC heders from invite request due to ', e);\n  }\n\n  session.canUseRCMCallControl = canUseRCMCallControl;\n  session.createSessionMessage = createSessionMessage;\n  session.sendSessionMessage = sendSessionMessage;\n  session.sendReceiveConfirm = sendReceiveConfirm;\n  session.toVoiceMail = toVoiceMail;\n\n  session.replyWithMessage = replyWithMessage;\n}\n"]}