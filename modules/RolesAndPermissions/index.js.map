{"version":3,"sources":["modules/RolesAndPermissions/index.js"],"names":["DEFAULT_TTL","extractData","permissions","output","forEach","item","permission","id","RolesAndPermissions","isCRM","flag","client","alert","extensionInfo","ttl","options","name","fetchFunction","_client","account","extension","authzProfile","get","readyCheckFn","_extensionInfo","ready","_isCRM","_flag","_alert","addSelector","data","_auth","loginStatus","loggedIn","tierEnabled","logout","danger","message","invalidTier","fetchData","serviceFeatures","_selectors","RingOut","enabled","WebPhone"],"mappings":"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","file":"index.js","sourcesContent":["import DataFetcher from '../../lib/DataFetcher';\nimport permissionsMessages from './permissionsMessages';\nimport loginStatus from '../Auth/loginStatus';\nimport ensureExist from '../../lib/ensureExist';\n\nconst DEFAULT_TTL = 24 * 60 * 60 * 1000;\n\nfunction extractData(permissions) {\n  const output = {};\n  permissions.permissions.forEach((item) => {\n    output[item.permission.id] = true;\n  });\n  return output;\n}\n\nexport default class RolesAndPermissions extends DataFetcher {\n  constructor({\n    isCRM,\n    flag,\n    client,\n    alert,\n    extensionInfo,\n    ttl = DEFAULT_TTL,\n    ...options\n  }) {\n    super({\n      ...options,\n      name: 'rolesAndPermissions',\n      client,\n      ttl,\n      fetchFunction: async () => extractData(\n        await this._client.account().extension().authzProfile().get()\n      ),\n      readyCheckFn: () => this._extensionInfo.ready,\n    });\n    this._isCRM = !!isCRM;\n    this._flag = flag || 'SalesForce';\n    this._alert = alert;\n    this._extensionInfo = ensureExist(extensionInfo, 'extensionInfo');\n    this.addSelector(\n      'permissions',\n      () => this.data,\n      data => data || {},\n    );\n  }\n\n  async _onStateChange() {\n    await super._onStateChange();\n    if (this.ready &&\n      this._auth.loginStatus === loginStatus.loggedIn &&\n      this._isCRM &&\n      this.tierEnabled !== null &&\n      !this.tierEnabled\n    ) {\n      await this._auth.logout();\n      this._alert.danger({\n        message: permissionsMessages.invalidTier,\n        ttl: 0,\n      });\n    }\n  }\n\n  refreshServiceFeatures() {\n    if (this._extensionInfo.ready) {\n      this._extensionInfo.fetchData();\n    }\n  }\n\n  get serviceFeatures() {\n    return this._extensionInfo.serviceFeatures;\n  }\n\n  get permissions() {\n    return this._selectors.permissions();\n  }\n\n  get ringoutEnabled() {\n    return !!(\n      this._extensionInfo.serviceFeatures &&\n      this._extensionInfo.serviceFeatures.RingOut &&\n      this._extensionInfo.serviceFeatures.RingOut.enabled\n    );\n  }\n\n  get webphoneEnabled() {\n    return !!(\n      this._extensionInfo.serviceFeatures &&\n      this._extensionInfo.serviceFeatures.WebPhone &&\n      this._extensionInfo.serviceFeatures.WebPhone.enabled\n    );\n  }\n\n  get tierEnabled() {\n    if (\n      !this._extensionInfo.serviceFeatures ||\n      !this._extensionInfo.serviceFeatures[this._flag]\n    ) {\n      return null;\n    }\n    return this._extensionInfo.serviceFeatures[this._flag].enabled;\n  }\n}\n"]}