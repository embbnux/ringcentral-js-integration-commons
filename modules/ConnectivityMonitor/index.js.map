{"version":3,"sources":["modules/ConnectivityMonitor/index.js"],"names":["DEFAULT_TIME_TO_RETRY","ConnectivityMonitor","alert","client","environment","timeToRetry","options","actionTypes","_requestSuccessHandler","connectivity","store","dispatch","type","connectSuccess","_alert","alertIds","messages","filter","m","message","disconnected","map","id","length","dismiss","_clearTimeout","_requestErrorHandler","apiResponse","Error","connectFail","showAlert","_retry","_client","_environment","_timeToRetry","_reducer","_timeoutId","subscribe","ready","_bindHandlers","initSuccess","changed","danger","ttl","allowDuplicates","_unbindHandlers","service","platform","on","events","requestSuccess","requestError","off","get","skipAuthCheck","clearTimeout","t","setTimeout","_checkConnection","state","status"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from '../../lib/RcModule';\nimport actionTypes from './actionTypes';\nimport moduleStatus from '../../enums/moduleStatus';\nimport getConnectivityMonitorReducer from './getConnectivityMonitorReducer';\nimport connectivityMonitorMessages from './connectivityMonitorMessages';\n\nconst DEFAULT_TIME_TO_RETRY = 5000;\n\nexport default class ConnectivityMonitor extends RcModule {\n  constructor({\n    alert,\n    client,\n    environment,\n    timeToRetry = DEFAULT_TIME_TO_RETRY,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._alert = alert;\n    this._client = client;\n    this._environment = environment;\n    this._timeToRetry = timeToRetry;\n    this._reducer = getConnectivityMonitorReducer(this.actionTypes);\n    this._timeoutId = null;\n  }\n  initialize() {\n    this.store.subscribe(async () => {\n      if (\n        !this.ready &&\n        (!this._environment || this._environment.ready)\n      ) {\n        this._bindHandlers();\n        this.store.dispatch({\n          type: this.actionTypes.initSuccess,\n        });\n      } else if (\n        this.ready &&\n        this._environment && this._environment.changed\n      ) {\n        this._bindHandlers();\n      }\n    });\n  }\n  _requestSuccessHandler = () => {\n    if (!this.connectivity) {\n      this.store.dispatch({\n        type: this.actionTypes.connectSuccess,\n      });\n      if (this._alert) {\n        // dismiss disconnected alerts if found\n        const alertIds = this._alert.messages.filter(m => (\n          m.message === connectivityMonitorMessages.disconnected\n        )).map(m => m.id);\n        if (alertIds.length) {\n          this._alert.dismiss(alertIds);\n        }\n      }\n    }\n    this._clearTimeout();\n  }\n  showAlert() {\n    if (!this.connectivity && this._alert) {\n      this._alert.danger({\n        message: connectivityMonitorMessages.disconnected,\n        ttl: 0,\n        allowDuplicates: false,\n      });\n    }\n  }\n  _requestErrorHandler = (apiResponse) => {\n    if (\n      apiResponse instanceof Error &&\n      apiResponse.message === 'Failed to fetch'\n    ) {\n      if (this.connectivity) {\n        this.store.dispatch({\n          type: this.actionTypes.connectFail,\n        });\n        this.showAlert();\n      }\n      this._retry();\n    }\n  }\n  _bindHandlers() {\n    if (this._unbindHandlers) {\n      this._unbindHandlers();\n    }\n    const client = this._client.service.platform().client();\n    client.on(client.events.requestSuccess, this._requestSuccessHandler);\n    client.on(client.events.requestError, this._requestErrorHandler);\n    this._unbindHandlers = () => {\n      client.off(client.events.requestSuccess, this._requestSuccessHandler);\n      client.off(client.events.requestError, this._requestErrorHandler);\n      this._unbindHandlers = null;\n    };\n  }\n\n  async _checkConnection() {\n    try {\n      // query api info as a test of connectivity\n      await this._client.service.platform().get('', null, { skipAuthCheck: true });\n    } catch (error) {\n      /* falls through */\n    }\n  }\n  _clearTimeout() {\n    if (this._timeoutId) clearTimeout(this._timeoutId);\n  }\n  _retry(t = this._timeToRetry) {\n    this._clearTimeout();\n    this._timeoutId = setTimeout(() => {\n      this._timeoutId = null;\n      this._checkConnection();\n    }, t);\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatus.ready;\n  }\n\n  get connectivity() {\n    return this.state.connectivity;\n  }\n}\n"]}