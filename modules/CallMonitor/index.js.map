{"version":3,"sources":["modules/CallMonitor/index.js"],"names":["CallMonitor","call","accountInfo","detailedPresence","activityMatcher","contactMatcher","webphone","onRinging","onNewCall","onCallUpdated","onCallEnded","storage","options","actionTypes","_call","_accountInfo","_detailedPresence","_contactMatcher","_activityMatcher","_webphone","_onRinging","_onNewCall","_onCallUpdated","_onCallEnded","_storage","_callMatchedKey","_reducer","registerReducer","key","reducer","addSelector","calls","countryCode","sessions","callsFromPresence","map","fromNumber","phoneNumber","from","toNumber","to","webphoneSession","sipData","find","session","direction","remoteUser","outbound","remoteUri","indexOf","startTime","creationTime","filter","id","sessionItem","sort","_selectors","normalizedCalls","dataMapping","callMatched","contactMapping","activityMapping","fromMatches","toMatches","toNumberEntity","sessionId","activityMatches","output","numberMap","addIfNotExist","number","push","forEach","addQuerySource","getQueriesFn","uniqueNumbers","readyCheckFn","ready","sessionIds","_lastProcessedNumbers","_lastProcessedCalls","_lastProcessedIds","pending","store","dispatch","type","init","initSuccess","reset","resetSuccess","triggerMatch","oldCalls","slice","length","toNumberEntities","cleanToNumberEntities","entities","oldCallIndex","findIndex","item","oldCall","splice","telephonyStatus","entity","index","toEntity","toMatch","entityId","undefined","_removeMatched","_setMatchedData","toEntityId","subscribe","_onStateChange","console","log","matched","setData","state","status","getItem"],"mappings":"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","file":"index.js","sourcesContent":["import 'core-js/fn/array/find';\nimport RcModule from '../../lib/RcModule';\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport actionTypes from './actionTypes';\nimport callDirections from '../../enums/callDirections';\nimport getCallMonitorReducer, {\n  getCallMatchedReducer\n} from './getCallMonitorReducer';\nimport normalizeNumber from '../../lib/normalizeNumber';\nimport {\n  isRinging,\n  hasRingingCalls,\n  sortByStartTime,\n} from '../../lib/callLogHelpers';\nimport ensureExist from '../../lib/ensureExist';\n\n\nexport default class CallMonitor extends RcModule {\n  constructor({\n    call,\n    accountInfo,\n    detailedPresence,\n    activityMatcher,\n    contactMatcher,\n    webphone,\n    onRinging,\n    onNewCall,\n    onCallUpdated,\n    onCallEnded,\n    storage,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._call = call;\n    this._accountInfo = this::ensureExist(accountInfo, 'accountInfo');\n    this._detailedPresence = this::ensureExist(detailedPresence, 'detailedPresence');\n    this._contactMatcher = contactMatcher;\n    this._activityMatcher = activityMatcher;\n    this._webphone = webphone;\n    this._onRinging = onRinging;\n    this._onNewCall = onNewCall;\n    this._onCallUpdated = onCallUpdated;\n    this._onCallEnded = onCallEnded;\n    this._storage = this::ensureExist(storage, 'storage');\n    this._callMatchedKey = 'callMatched';\n\n    this._reducer = getCallMonitorReducer(this.actionTypes);\n\n    this._storage.registerReducer({\n      key: this._callMatchedKey,\n      reducer: getCallMatchedReducer(this.actionTypes),\n    });\n\n\n    this.addSelector('normalizedCalls',\n      () => this._detailedPresence.calls,\n      () => this._accountInfo.countryCode,\n      () => this._webphone && this._webphone.sessions,\n      (callsFromPresence, countryCode, sessions) => (\n        callsFromPresence.map((call) => {\n          // use account countryCode to normalize number due to API issues [RCINT-3419]\n          const fromNumber = normalizeNumber({\n            phoneNumber: call.from && call.from.phoneNumber,\n            countryCode,\n          });\n          const toNumber = normalizeNumber({\n            phoneNumber: call.to && call.to.phoneNumber,\n            countryCode,\n          });\n          let webphoneSession;\n          if (sessions && call.sipData) {\n            webphoneSession = sessions.find((session) => {\n              if (session.direction !== call.direction) {\n                return false;\n              }\n              let remoteUser;\n              if (session.direction === callDirections.outbound) {\n                remoteUser = session.to;\n              } else {\n                remoteUser = session.from;\n              }\n              if (call.sipData.remoteUri.indexOf(remoteUser) === -1) {\n                return false;\n              }\n              const startTime = session.startTime || session.creationTime;\n              if (\n                call.startTime - startTime > 4000 ||\n                session.startTime - startTime > 4000\n              ) {\n                return false;\n              }\n              return true;\n            });\n          }\n\n          return {\n            ...call,\n            from: {\n              phoneNumber: fromNumber,\n            },\n            to: {\n              phoneNumber: toNumber,\n            },\n            startTime: (\n              (webphoneSession && webphoneSession.startTime) ||\n              call.startTime\n            ),\n            webphoneSession,\n          };\n        }).filter((call) => {\n          if (!call.webphoneSession || !sessions) {\n            return true;\n          }\n          const session = sessions.find(\n            sessionItem => call.webphoneSession.id === sessionItem.id\n          );\n          return !!session;\n        }).sort(sortByStartTime)\n      ),\n    );\n    this.addSelector('calls',\n      this._selectors.normalizedCalls,\n      () => (this._contactMatcher && this._contactMatcher.dataMapping),\n      () => (this._activityMatcher && this._activityMatcher.dataMapping),\n      () => (this.callMatched),\n      (normalizedCalls, contactMapping = {}, activityMapping = {}, callMatched) => {\n        const calls = normalizedCalls.map((call) => {\n          const fromNumber = call.from && call.from.phoneNumber;\n          const toNumber = call.to && call.to.phoneNumber;\n          const fromMatches = (fromNumber && contactMapping[fromNumber]) || [];\n          const toMatches = (toNumber && contactMapping[toNumber]) || [];\n          const toNumberEntity = callMatched[call.sessionId];\n          return {\n            ...call,\n            fromMatches,\n            toMatches,\n            activityMatches: (activityMapping[call.sessionId]) || [],\n            toNumberEntity,\n          };\n        });\n        return calls;\n      }\n    );\n\n    this.addSelector('uniqueNumbers',\n      this._selectors.normalizedCalls,\n      (normalizedCalls) => {\n        const output = [];\n        const numberMap = {};\n        function addIfNotExist(number) {\n          if (!numberMap[number]) {\n            output.push(number);\n            numberMap[number] = true;\n          }\n        }\n        normalizedCalls.forEach((call) => {\n          if (call.from && call.from.phoneNumber) {\n            addIfNotExist(call.from.phoneNumber);\n          }\n          if (call.to && call.to.phoneNumber) {\n            addIfNotExist(call.to.phoneNumber);\n          }\n        });\n        return output;\n      }\n    );\n\n    if (this._contactMatcher) {\n      this._contactMatcher.addQuerySource({\n        getQueriesFn: this._selectors.uniqueNumbers,\n        readyCheckFn: () => (\n          this._accountInfo.ready &&\n          this._detailedPresence.ready\n        ),\n      });\n    }\n    this.addSelector('sessionIds',\n      () => this._detailedPresence.calls,\n      calls => calls.map(call => call.sessionId)\n    );\n    if (this._activityMatcher) {\n      this._activityMatcher.addQuerySource({\n        getQueriesFn: this._selectors.sessionIds,\n        readyCheckFn: () => this._detailedPresence.ready,\n      });\n    }\n\n    this._lastProcessedNumbers = null;\n    this._lastProcessedCalls = null;\n    this._lastProcessedIds = null;\n  }\n\n  async _onStateChange() {\n    if (\n      (!this._call || this._call.ready) &&\n      this._accountInfo.ready &&\n      this._detailedPresence.ready &&\n      (!this._contactMatcher || this._contactMatcher.ready) &&\n      (!this._activityMatcher || this._activityMatcher.ready) &&\n      this._storage.ready &&\n      this.pending\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.init,\n      });\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    } else if (\n      (\n        (this._call && !this._call.ready) ||\n        !this._accountInfo.ready ||\n        !this._detailedPresence.ready ||\n        (this._contactMatcher && !this._contactMatcher.ready) ||\n        (this._activityMatcher && !this._activityMatcher.ready) ||\n        !this._storage.ready\n      ) &&\n      this.ready\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.reset,\n      });\n      this._lastProcessedCalls = null;\n      this._lastProcessedIds = null;\n      this._lastProcessedNumbers = null;\n      this.store.dispatch({\n        type: this.actionTypes.resetSuccess,\n      });\n    } else if (\n      this.ready\n    ) {\n      const uniqueNumbers = this._selectors.uniqueNumbers();\n      if (this._lastProcessedNumbers !== uniqueNumbers) {\n        this._lastProcessedNumbers = uniqueNumbers;\n        if (this._contactMatcher && this._contactMatcher.ready) {\n          this._contactMatcher.triggerMatch();\n        }\n      }\n      const sessionIds = this._selectors.sessionIds();\n      if (this._lastProcessedIds !== sessionIds) {\n        this._lastProcessedIds = sessionIds;\n        if (this._activityMatcher && this._activityMatcher.ready) {\n          this._activityMatcher.triggerMatch();\n        }\n      }\n\n      if (\n        this._lastProcessedCalls !== this.calls\n      ) {\n        const oldCalls = (\n          this._lastProcessedCalls &&\n          this._lastProcessedCalls.slice()\n        ) || [];\n\n        this._lastProcessedCalls = this.calls;\n\n        // no ringing calls\n        if (this._call &&\n            oldCalls.length !== 0 &&\n            this.calls.length === 0 &&\n            this._call.toNumberEntities &&\n            this._call.toNumberEntities.length !== 0) {\n          // console.log('no calls clean to number:');\n          this._call.cleanToNumberEntities();\n        }\n\n        let entities = this._call ? this._call.toNumberEntities.sort(sortByStartTime) : [];\n        // const matchedMap = {};\n        this.calls.forEach((call) => {\n          const oldCallIndex = oldCalls.findIndex(item => item.sessionId === call.sessionId);\n          if (oldCallIndex === -1) {\n            if (typeof this._onNewCall === 'function') {\n              this._onNewCall(call);\n            }\n            if (typeof this._onRinging === 'function' && isRinging(call)) {\n              this._onRinging(call);\n            }\n          } else {\n            const oldCall = oldCalls[oldCallIndex];\n            oldCalls.splice(oldCallIndex, 1);\n            if (\n              call.telephonyStatus !== oldCall.telephonyStatus &&\n              typeof this._onCallUpdated === 'function'\n            ) {\n              this._onCallUpdated(call);\n            }\n          }\n          entities.find((entity, index) => {\n            const toEntity = call.toMatches.find(toMatch =>\n              toMatch.id === entity.entityId\n            );\n            if (toEntity !== undefined) {\n              entities = this._removeMatched(index, entities);\n              this._setMatchedData({\n                sessionId: call.sessionId,\n                toEntityId: toEntity.id,\n              });\n              return true;\n            }\n            return false;\n          });\n        });\n\n        oldCalls.forEach((call) => {\n          if (typeof this._onCallEnded === 'function') {\n            this._onCallEnded(call);\n          }\n        });\n      }\n    }\n  }\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  _removeMatched(index, entities) {\n    console.log('removeMatched:', index);\n    entities.splice(index, 1);\n    console.log('entities after splice:', entities);\n    return entities;\n  }\n\n  _setMatchedData(matched) {\n    this.store.dispatch({\n      type: this.actionTypes.setData,\n      ...matched,\n    });\n  }\n\n  get hasRingingCalls() {\n    return hasRingingCalls(this.calls);\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatuses.ready;\n  }\n\n  get pending() {\n    return this.state.status === moduleStatuses.pending;\n  }\n\n  get calls() {\n    return this._selectors.calls();\n  }\n\n  get callMatched() {\n    return this._storage.getItem(this._callMatchedKey);\n  }\n}\n"]}