{"version":3,"sources":["modules/CallMonitor/index.js"],"names":["CallMonitor","accountInfo","detailedPresence","activeCalls","activityMatcher","contactMatcher","webphone","onRinging","onNewCall","onCallUpdated","onCallEnded","options","actionTypes","_onStateChange","_accountInfo","ready","_detailedPresence","_activeCalls","_contactMatcher","_activityMatcher","pending","store","dispatch","type","init","initSuccess","reset","_lastProcessedCalls","_lastProcessedIds","_lastProcessedNumbers","resetSuccess","uniqueNumbers","_selectors","triggerMatch","sessionIds","calls","oldCalls","slice","forEach","call","oldCallIndex","findIndex","item","sessionId","_onNewCall","_onRinging","oldCall","splice","telephonyStatus","_onCallUpdated","_onCallEnded","_webphone","_reducer","addSelector","countryCode","sessions","callsFromPresence","callsFromActiveCalls","map","activeCall","inboundLeg","find","fromNumber","phoneNumber","from","toNumber","to","webphoneSession","sipData","session","direction","remoteUri","outbound","request","uri","user","indexOf","sipStartTime","Date","startTime","getTime","normalizedCalls","dataMapping","contactMapping","activityMapping","fromMatches","toMatches","activityMatches","sort","output","numberMap","addIfNotExist","number","push","addQuerySource","getQueriesFn","readyCheckFn","subscribe","state","status"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;AAIA;;;;;;IAGqBA,W;;;AACnB,6BAYG;AAAA;;AAAA,QAXDC,WAWC,QAXDA,WAWC;AAAA,QAVDC,gBAUC,QAVDA,gBAUC;AAAA,QATDC,WASC,QATDA,WASC;AAAA,QARDC,eAQC,QARDA,eAQC;AAAA,QAPDC,cAOC,QAPDA,cAOC;AAAA,QANDC,QAMC,QANDA,QAMC;AAAA,QALDC,SAKC,QALDA,SAKC;AAAA,QAJDC,SAIC,QAJDA,SAIC;AAAA,QAHDC,aAGC,QAHDA,aAGC;AAAA,QAFDC,WAEC,QAFDA,WAEC;AAAA,QADEC,OACF;AAAA;;AAAA,2KAEIA,OAFJ;AAGCC;AAHD;;AAAA,UAiJHC,cAjJG,8DAiJc;AAAA;AAAA;AAAA;AAAA;AAAA;AACf,kBACE,MAAKC,YAAL,CAAkBC,KAAlB,IACA,MAAKC,iBAAL,CAAuBD,KADvB,IAEA,MAAKE,YAAL,CAAkBF,KAFlB,KAGC,CAAC,MAAKG,eAAN,IAAyB,MAAKA,eAAL,CAAqBH,KAH/C,MAIC,CAAC,MAAKI,gBAAN,IAA0B,MAAKA,gBAAL,CAAsBJ,KAJjD,KAKA,MAAKK,OANP,EAOE;AACA,sBAAKC,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,MAAKX,WAAL,CAAiBY;AADL,iBAApB;AAGA,sBAAKH,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,MAAKX,WAAL,CAAiBa;AADL,iBAApB;AAGD,eAdD,MAcO,IACL,CACE,CAAC,MAAKX,YAAL,CAAkBC,KAAnB,IACA,CAAC,MAAKC,iBAAL,CAAuBD,KADxB,IAEA,CAAC,MAAKE,YAAL,CAAkBF,KAFnB,IAGC,MAAKG,eAAL,IAAwB,CAAC,MAAKA,eAAL,CAAqBH,KAH/C,IAIC,MAAKI,gBAAL,IAAyB,CAAC,MAAKA,gBAAL,CAAsBJ,KALnD,KAOA,MAAKA,KARA,EASL;AACA,sBAAKM,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,MAAKX,WAAL,CAAiBc;AADL,iBAApB;AAGA,sBAAKC,mBAAL,GAA2B,IAA3B;AACA,sBAAKC,iBAAL,GAAyB,IAAzB;AACA,sBAAKC,qBAAL,GAA6B,IAA7B;AACA,sBAAKR,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,MAAKX,WAAL,CAAiBkB;AADL,iBAApB;AAGD,eAnBM,MAmBA,IACL,MAAKf,KADA,EAEL;AACMgB,6BADN,GACsB,MAAKC,UAAL,CAAgBD,aAAhB,EADtB;;AAEA,oBAAI,MAAKF,qBAAL,KAA+BE,aAAnC,EAAkD;AAChD,wBAAKF,qBAAL,GAA6BE,aAA7B;AACA,sBAAI,MAAKb,eAAL,IAAwB,MAAKA,eAAL,CAAqBH,KAAjD,EAAwD;AACtD,0BAAKG,eAAL,CAAqBe,YAArB;AACD;AACF;AACKC,0BARN,GAQmB,MAAKF,UAAL,CAAgBE,UAAhB,EARnB;;AASA,oBAAI,MAAKN,iBAAL,KAA2BM,UAA/B,EAA2C;AACzC,wBAAKN,iBAAL,GAAyBM,UAAzB;AACA,sBAAI,MAAKf,gBAAL,IAAyB,MAAKA,gBAAL,CAAsBJ,KAAnD,EAA0D;AACxD,0BAAKI,gBAAL,CAAsBc,YAAtB;AACD;AACF;;AAED,oBACE,MAAKN,mBAAL,KAA6B,MAAKQ,KADpC,EAEE;AACMC,0BADN,GAEE,MAAKT,mBAAL,IACA,MAAKA,mBAAL,CAAyBU,KAAzB,EAFe,IAGZ,EAJL;;AAKA,wBAAKV,mBAAL,GAA2B,MAAKQ,KAAhC;;AAEA,wBAAKA,KAAL,CAAWG,OAAX,CAAmB,UAACC,IAAD,EAAU;AAC3B,wBAAMC,eAAeJ,SAASK,SAAT,CAAmB;AAAA,6BAAQC,KAAKC,SAAL,KAAmBJ,KAAKI,SAAhC;AAAA,qBAAnB,CAArB;AACA,wBAAIH,iBAAiB,CAAC,CAAtB,EAAyB;AACvB,0BAAI,OAAO,MAAKI,UAAZ,KAA2B,UAA/B,EAA2C;AACzC,8BAAKA,UAAL,CAAgBL,IAAhB;AACD;AACD,0BAAI,OAAO,MAAKM,UAAZ,KAA2B,UAA3B,IAAyC,+BAAUN,IAAV,CAA7C,EAA8D;AAC5D,8BAAKM,UAAL,CAAgBN,IAAhB;AACD;AACF,qBAPD,MAOO;AACL,0BAAMO,UAAUV,SAASI,YAAT,CAAhB;AACAJ,+BAASW,MAAT,CAAgBP,YAAhB,EAA8B,CAA9B;AACA,0BACED,KAAKS,eAAL,KAAyBF,QAAQE,eAAjC,IACA,OAAO,MAAKC,cAAZ,KAA+B,UAFjC,EAGE;AACA,8BAAKA,cAAL,CAAoBV,IAApB;AACD;AACF;AACF,mBAnBD;AAoBAH,2BAASE,OAAT,CAAiB,UAACC,IAAD,EAAU;AACzB,wBAAI,OAAO,MAAKW,YAAZ,KAA6B,UAAjC,EAA6C;AAC3C,4BAAKA,YAAL,CAAkBX,IAAlB;AACD;AACF,mBAJD;AAKD;AACF;;AAvFc;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAjJd;;AAKD,UAAKzB,YAAL,GAAoB,kCAAkBb,WAAlB,EAA+B,aAA/B,CAApB;AACA,UAAKe,iBAAL,GAAyB,kCAAkBd,gBAAlB,EAAoC,kBAApC,CAAzB;AACA,UAAKe,YAAL,GAAoB,kCAAkBd,WAAlB,EAA+B,aAA/B,CAApB;AACA,UAAKe,eAAL,GAAuBb,cAAvB;AACA,UAAKc,gBAAL,GAAwBf,eAAxB;AACA,UAAK+C,SAAL,GAAiB7C,QAAjB;AACA,UAAKuC,UAAL,GAAkBtC,SAAlB;AACA,UAAKqC,UAAL,GAAkBpC,SAAlB;AACA,UAAKyC,cAAL,GAAsBxC,aAAtB;AACA,UAAKyC,YAAL,GAAoBxC,WAApB;;AAEA,UAAK0C,QAAL,GAAgB,qCAAsB,MAAKxC,WAA3B,CAAhB;AACA,UAAKyC,WAAL,CAAiB,iBAAjB,EACE;AAAA,aAAM,MAAKrC,iBAAL,CAAuBmB,KAA7B;AAAA,KADF,EAEE;AAAA,aAAM,MAAKlB,YAAL,CAAkBkB,KAAxB;AAAA,KAFF,EAGE;AAAA,aAAM,MAAKrB,YAAL,CAAkBwC,WAAxB;AAAA,KAHF,EAIE;AAAA,aAAM,MAAKH,SAAL,IAAkB,MAAKA,SAAL,CAAeI,QAAvC;AAAA,KAJF,EAKE,UAACC,iBAAD,EAAoBC,oBAApB,EAA0CH,WAA1C,EAAuDC,QAAvD;AAAA,aACEC,kBAAkBE,GAAlB,CAAsB,UAACnB,IAAD,EAAU;AAC9B,YAAMoB,aAAapB,KAAKqB,UAAL,IACjBH,qBAAqBI,IAArB,CAA0B;AAAA,iBAAQnB,KAAKC,SAAL,KAAmBJ,KAAKqB,UAAL,CAAgBjB,SAA3C;AAAA,SAA1B,CADF;;AAGA;AACA,YAAMmB,aAAa,+BAAgB;AACjCC,uBAAaxB,KAAKyB,IAAL,IAAazB,KAAKyB,IAAL,CAAUD,WADH;AAEjCT;AAFiC,SAAhB,CAAnB;AAIA,YAAMW,WAAW,+BAAgB;AAC/BF,uBAAaxB,KAAK2B,EAAL,IAAW3B,KAAK2B,EAAL,CAAQH,WADD;AAE/BT;AAF+B,SAAhB,CAAjB;AAIA,YAAIa,wBAAJ;AACA,YAAIZ,YAAYhB,KAAK6B,OAArB,EAA8B;AAC5Bb,mBAASjB,OAAT,CAAiB,UAAC+B,OAAD,EAAa;AAC5B,gBAAIF,eAAJ,EAAqB;AACnB;AACD;AACD,gBAAIE,QAAQC,SAAR,KAAsB/B,KAAK+B,SAA/B,EAA0C;AACxC;AACD;AACD,gBAAIC,kBAAJ;AACA,gBAAIF,QAAQC,SAAR,KAAsB,yBAAeE,QAAzC,EAAmD;AACjDD,0BAAYF,QAAQI,OAAR,CAAgBP,EAAhB,CAAmBQ,GAAnB,CAAuBC,IAAnC;AACD,aAFD,MAEO;AACLJ,0BAAYF,QAAQI,OAAR,CAAgBT,IAAhB,CAAqBU,GAArB,CAAyBC,IAArC;AACD;AACD,gBAAIpC,KAAK6B,OAAL,CAAaG,SAAb,CAAuBK,OAAvB,CAA+BL,SAA/B,MAA8C,CAAC,CAAnD,EAAsD;AACpD;AACD;AACD,gBAAMM,eAAgB,IAAIC,IAAJ,CAAST,QAAQU,SAAjB,CAAD,CAA8BC,OAA9B,EAArB;AACA,gBAAIzC,KAAKwC,SAAL,GAAiBF,YAAjB,GAAgC,IAAhC,IAAwCA,eAAetC,KAAKwC,SAApB,GAAgC,IAA5E,EAAkF;AAChF;AACD;AACDZ,8BAAkBE,OAAlB;AACD,WArBD;AAsBD;;AAED,0CACK9B,IADL;AAEEyB,2CACOL,cAAcA,WAAWO,EAA1B,IAAiC,EADvC;AAEEH,yBAAaD;AAFf,YAFF;AAMEI,yCACOP,cAAcA,WAAWK,IAA1B,IAAmC,EADzC;AAEED,yBAAaE;AAFf,YANF;AAUEc,qBAAYpB,cAAcA,WAAWoB,SAA1B,IAAwCxC,KAAKwC,SAV1D;AAWEZ;AAXF;AAaD,OApDD,CADF;AAAA,KALF;AA6DA,UAAKd,WAAL,CAAiB,OAAjB,EACE,MAAKrB,UAAL,CAAgBiD,eADlB,EAEE;AAAA,aAAO,MAAK/D,eAAL,IAAwB,MAAKA,eAAL,CAAqBgE,WAApD;AAAA,KAFF,EAGE;AAAA,aAAO,MAAK/D,gBAAL,IAAyB,MAAKA,gBAAL,CAAsB+D,WAAtD;AAAA,KAHF,EAIE,UAACD,eAAD;AAAA,UAAkBE,cAAlB,uEAAmC,EAAnC;AAAA,UAAuCC,eAAvC,uEAAyD,EAAzD;AAAA,aACEH,gBAAgBvB,GAAhB,CAAoB,UAACnB,IAAD,EAAU;AAC5B,YAAMuB,aAAavB,KAAKyB,IAAL,IAAazB,KAAKyB,IAAL,CAAUD,WAA1C;AACA,YAAME,WAAW1B,KAAK2B,EAAL,IAAW3B,KAAK2B,EAAL,CAAQH,WAApC;AACA,0CACKxB,IADL;AAEE8C,uBAAcvB,cAAcqB,eAAerB,UAAf,CAAf,IAA8C,EAF7D;AAGEwB,qBAAYrB,YAAYkB,eAAelB,QAAf,CAAb,IAA0C,EAHvD;AAIEsB,2BAAkBH,gBAAgB7C,KAAKI,SAArB,CAAD,IAAqC;AAJxD;AAMD,OATD,EASG6C,IATH,iCADF;AAAA,KAJF;;AAkBA,UAAKnC,WAAL,CAAiB,eAAjB,EACE,MAAKrB,UAAL,CAAgBiD,eADlB,EAEE,UAACA,eAAD,EAAqB;AACnB,UAAMQ,SAAS,EAAf;AACA,UAAMC,YAAY,EAAlB;AACA,eAASC,aAAT,CAAuBC,MAAvB,EAA+B;AAC7B,YAAI,CAACF,UAAUE,MAAV,CAAL,EAAwB;AACtBH,iBAAOI,IAAP,CAAYD,MAAZ;AACAF,oBAAUE,MAAV,IAAoB,IAApB;AACD;AACF;AACDX,sBAAgB3C,OAAhB,CAAwB,UAACC,IAAD,EAAU;AAChC,YAAIA,KAAKyB,IAAL,IAAazB,KAAKyB,IAAL,CAAUD,WAA3B,EAAwC;AACtC4B,wBAAcpD,KAAKyB,IAAL,CAAUD,WAAxB;AACD;AACD,YAAIxB,KAAK2B,EAAL,IAAW3B,KAAK2B,EAAL,CAAQH,WAAvB,EAAoC;AAClC4B,wBAAcpD,KAAK2B,EAAL,CAAQH,WAAtB;AACD;AACF,OAPD;AAQA,aAAO0B,MAAP;AACD,KApBH;;AAuBA,QAAI,MAAKvE,eAAT,EAA0B;AACxB,YAAKA,eAAL,CAAqB4E,cAArB,CAAoC;AAClCC,sBAAc,MAAK/D,UAAL,CAAgBD,aADI;AAElCiE,sBAAc;AAAA,iBACZ,MAAKlF,YAAL,CAAkBC,KAAlB,IACA,MAAKE,YAAL,CAAkBF,KADlB,IAEA,MAAKC,iBAAL,CAAuBD,KAHX;AAAA;AAFoB,OAApC;AAQD;AACD,UAAKsC,WAAL,CAAiB,YAAjB,EACE;AAAA,aAAM,MAAKrC,iBAAL,CAAuBmB,KAA7B;AAAA,KADF,EAEE;AAAA,aAASA,MAAMuB,GAAN,CAAU;AAAA,eAAQnB,KAAKI,SAAb;AAAA,OAAV,CAAT;AAAA,KAFF;AAIA,QAAI,MAAKxB,gBAAT,EAA2B;AACzB,YAAKA,gBAAL,CAAsB2E,cAAtB,CAAqC;AACnCC,sBAAc,MAAK/D,UAAL,CAAgBE,UADK;AAEnC8D,sBAAc;AAAA,iBAAM,MAAKhF,iBAAL,CAAuBD,KAA7B;AAAA;AAFqB,OAArC;AAID;;AAED,UAAKc,qBAAL,GAA6B,IAA7B;AACA,UAAKF,mBAAL,GAA2B,IAA3B;AACA,UAAKC,iBAAL,GAAyB,IAAzB;AA9IC;AA+IF;;;;iCA2FY;AACX,WAAKP,KAAL,CAAW4E,SAAX,CAAqB,KAAKpF,cAA1B;AACD;;;wBAEY;AACX,aAAO,KAAKqF,KAAL,CAAWC,MAAlB;AACD;;;wBAEW;AACV,aAAO,KAAKD,KAAL,CAAWC,MAAX,KAAsB,yBAAepF,KAA5C;AACD;;;wBAEa;AACZ,aAAO,KAAKmF,KAAL,CAAWC,MAAX,KAAsB,yBAAe/E,OAA5C;AACD;;;wBAEW;AACV,aAAO,KAAKY,UAAL,CAAgBG,KAAhB,EAAP;AACD;;;;;kBAzQkBnC,W","file":"index.js","sourcesContent":["import 'core-js/fn/array/find';\nimport RcModule from '../../lib/RcModule';\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport actionTypes from './actionTypes';\nimport callDirections from '../../enums/callDirections';\nimport getCallMonitorReducer from './getCallMonitorReducer';\nimport normalizeNumber from '../../lib/normalizeNumber';\nimport {\n  isRinging,\n  sortByStartTime,\n} from '../../lib/callLogHelpers';\nimport ensureExist from '../../lib/ensureExist';\n\n\nexport default class CallMonitor extends RcModule {\n  constructor({\n    accountInfo,\n    detailedPresence,\n    activeCalls,\n    activityMatcher,\n    contactMatcher,\n    webphone,\n    onRinging,\n    onNewCall,\n    onCallUpdated,\n    onCallEnded,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._accountInfo = this::ensureExist(accountInfo, 'accountInfo');\n    this._detailedPresence = this::ensureExist(detailedPresence, 'detailedPresence');\n    this._activeCalls = this::ensureExist(activeCalls, 'activeCalls');\n    this._contactMatcher = contactMatcher;\n    this._activityMatcher = activityMatcher;\n    this._webphone = webphone;\n    this._onRinging = onRinging;\n    this._onNewCall = onNewCall;\n    this._onCallUpdated = onCallUpdated;\n    this._onCallEnded = onCallEnded;\n\n    this._reducer = getCallMonitorReducer(this.actionTypes);\n    this.addSelector('normalizedCalls',\n      () => this._detailedPresence.calls,\n      () => this._activeCalls.calls,\n      () => this._accountInfo.countryCode,\n      () => this._webphone && this._webphone.sessions,\n      (callsFromPresence, callsFromActiveCalls, countryCode, sessions) => (\n        callsFromPresence.map((call) => {\n          const activeCall = call.inboundLeg &&\n            callsFromActiveCalls.find(item => item.sessionId === call.inboundLeg.sessionId);\n\n          // use account countryCode to normalize number due to API issues [RCINT-3419]\n          const fromNumber = normalizeNumber({\n            phoneNumber: call.from && call.from.phoneNumber,\n            countryCode,\n          });\n          const toNumber = normalizeNumber({\n            phoneNumber: call.to && call.to.phoneNumber,\n            countryCode,\n          });\n          let webphoneSession;\n          if (sessions && call.sipData) {\n            sessions.forEach((session) => {\n              if (webphoneSession) {\n                return;\n              }\n              if (session.direction !== call.direction) {\n                return;\n              }\n              let remoteUri;\n              if (session.direction === callDirections.outbound) {\n                remoteUri = session.request.to.uri.user;\n              } else {\n                remoteUri = session.request.from.uri.user;\n              }\n              if (call.sipData.remoteUri.indexOf(remoteUri) === -1) {\n                return;\n              }\n              const sipStartTime = (new Date(session.startTime)).getTime();\n              if (call.startTime - sipStartTime > 5000 || sipStartTime - call.startTime > 5000) {\n                return;\n              }\n              webphoneSession = session;\n            });\n          }\n\n          return {\n            ...call,\n            from: {\n              ...((activeCall && activeCall.to) || {}),\n              phoneNumber: fromNumber,\n            },\n            to: {\n              ...((activeCall && activeCall.from) || {}),\n              phoneNumber: toNumber,\n            },\n            startTime: (activeCall && activeCall.startTime) || call.startTime,\n            webphoneSession,\n          };\n        })\n      ),\n    );\n    this.addSelector('calls',\n      this._selectors.normalizedCalls,\n      () => (this._contactMatcher && this._contactMatcher.dataMapping),\n      () => (this._activityMatcher && this._activityMatcher.dataMapping),\n      (normalizedCalls, contactMapping = {}, activityMapping = {}) => (\n        normalizedCalls.map((call) => {\n          const fromNumber = call.from && call.from.phoneNumber;\n          const toNumber = call.to && call.to.phoneNumber;\n          return {\n            ...call,\n            fromMatches: (fromNumber && contactMapping[fromNumber]) || [],\n            toMatches: (toNumber && contactMapping[toNumber]) || [],\n            activityMatches: (activityMapping[call.sessionId]) || [],\n          };\n        }).sort(sortByStartTime)\n      )\n    );\n\n    this.addSelector('uniqueNumbers',\n      this._selectors.normalizedCalls,\n      (normalizedCalls) => {\n        const output = [];\n        const numberMap = {};\n        function addIfNotExist(number) {\n          if (!numberMap[number]) {\n            output.push(number);\n            numberMap[number] = true;\n          }\n        }\n        normalizedCalls.forEach((call) => {\n          if (call.from && call.from.phoneNumber) {\n            addIfNotExist(call.from.phoneNumber);\n          }\n          if (call.to && call.to.phoneNumber) {\n            addIfNotExist(call.to.phoneNumber);\n          }\n        });\n        return output;\n      }\n    );\n\n    if (this._contactMatcher) {\n      this._contactMatcher.addQuerySource({\n        getQueriesFn: this._selectors.uniqueNumbers,\n        readyCheckFn: () => (\n          this._accountInfo.ready &&\n          this._activeCalls.ready &&\n          this._detailedPresence.ready\n        ),\n      });\n    }\n    this.addSelector('sessionIds',\n      () => this._detailedPresence.calls,\n      calls => calls.map(call => call.sessionId)\n    );\n    if (this._activityMatcher) {\n      this._activityMatcher.addQuerySource({\n        getQueriesFn: this._selectors.sessionIds,\n        readyCheckFn: () => this._detailedPresence.ready,\n      });\n    }\n\n    this._lastProcessedNumbers = null;\n    this._lastProcessedCalls = null;\n    this._lastProcessedIds = null;\n  }\n\n  _onStateChange = async () => {\n    if (\n      this._accountInfo.ready &&\n      this._detailedPresence.ready &&\n      this._activeCalls.ready &&\n      (!this._contactMatcher || this._contactMatcher.ready) &&\n      (!this._activityMatcher || this._activityMatcher.ready) &&\n      this.pending\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.init,\n      });\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    } else if (\n      (\n        !this._accountInfo.ready ||\n        !this._detailedPresence.ready ||\n        !this._activeCalls.ready ||\n        (this._contactMatcher && !this._contactMatcher.ready) ||\n        (this._activityMatcher && !this._activityMatcher.ready)\n      ) &&\n      this.ready\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.reset,\n      });\n      this._lastProcessedCalls = null;\n      this._lastProcessedIds = null;\n      this._lastProcessedNumbers = null;\n      this.store.dispatch({\n        type: this.actionTypes.resetSuccess,\n      });\n    } else if (\n      this.ready\n    ) {\n      const uniqueNumbers = this._selectors.uniqueNumbers();\n      if (this._lastProcessedNumbers !== uniqueNumbers) {\n        this._lastProcessedNumbers = uniqueNumbers;\n        if (this._contactMatcher && this._contactMatcher.ready) {\n          this._contactMatcher.triggerMatch();\n        }\n      }\n      const sessionIds = this._selectors.sessionIds();\n      if (this._lastProcessedIds !== sessionIds) {\n        this._lastProcessedIds = sessionIds;\n        if (this._activityMatcher && this._activityMatcher.ready) {\n          this._activityMatcher.triggerMatch();\n        }\n      }\n\n      if (\n        this._lastProcessedCalls !== this.calls\n      ) {\n        const oldCalls = (\n          this._lastProcessedCalls &&\n          this._lastProcessedCalls.slice()\n        ) || [];\n        this._lastProcessedCalls = this.calls;\n\n        this.calls.forEach((call) => {\n          const oldCallIndex = oldCalls.findIndex(item => item.sessionId === call.sessionId);\n          if (oldCallIndex === -1) {\n            if (typeof this._onNewCall === 'function') {\n              this._onNewCall(call);\n            }\n            if (typeof this._onRinging === 'function' && isRinging(call)) {\n              this._onRinging(call);\n            }\n          } else {\n            const oldCall = oldCalls[oldCallIndex];\n            oldCalls.splice(oldCallIndex, 1);\n            if (\n              call.telephonyStatus !== oldCall.telephonyStatus &&\n              typeof this._onCallUpdated === 'function'\n            ) {\n              this._onCallUpdated(call);\n            }\n          }\n        });\n        oldCalls.forEach((call) => {\n          if (typeof this._onCallEnded === 'function') {\n            this._onCallEnded(call);\n          }\n        });\n      }\n    }\n  }\n  initialize() {\n    this.store.subscribe(this._onStateChange);\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatuses.ready;\n  }\n\n  get pending() {\n    return this.state.status === moduleStatuses.pending;\n  }\n\n  get calls() {\n    return this._selectors.calls();\n  }\n}\n"]}