{"version":3,"sources":["modules/MessageStore/index.js"],"names":["processResponseData","messageHelper","messageStoreHelper","data","records","slice","reverse","syncTimestamp","Date","syncInfo","syncTime","getTime","syncToken","MessageStore","alert","client","auth","ttl","storage","subscription","options","actionTypes","_alert","_client","_storage","_subscription","_reducer","_ttl","_auth","_promise","_lastSubscriptionMessage","_storageKey","registerReducer","key","reducer","addSelector","allConversations","conversations","unreadCounts","forEach","conversation","messageIsTextMessage","filter","messageIsFax","messageIsVoicemail","syncConversation","bind","store","subscribe","_onStateChange","_shouldInit","dispatch","type","init","_shouleCleanCache","_cleanUpCache","_initMessageStore","_shouldReset","_resetModuleStatus","ready","_subscriptionHandler","pending","isFreshLogin","now","updatedTimestamp","resetSuccess","cleanUp","id","conversationMap","toString","_syncMessages","console","error","initSuccess","accountExtesionEndPoint","message","test","event","body","changes","params","account","extension","messageSync","list","response","dateFrom","dateTo","recordsLength","MAX_MSG_LENGTH","getMessageSyncParams","_messageSyncApi","length","olderRecordsExist","_dateTo","creationTime","_recursiveFSync","lastResponse","concat","sync","oldSyncToken","syncSuccess","conversationId","syncConversationSuccess","syncConversationId","_sync","_updateMessagesFromSync","_updateConversationFromSync","syncFunction","_onSyncError","syncError","messageId","status","readStatus","messageStore","put","updateRequest","messageIds","ids","decodeURIComponent","join","platform","service","url","responses","_updateMessageApi","result","UPDATE_MESSAGE_ONCE_COUNT","leftIds","rightIds","map","_batchUpdateMessagesApi","results","res","push","json","_updateMessagesApi","rightResults","unreadMessageIds","unreadMessages","updatedMessages","updateMessages","searchText","messages","subject","toLowerCase","indexOf","recipients","updateConversationRecipients","record","pushMessages","getItem","cache","_selectors","voicemailMessages","faxMessages","textConversations","state","messageStoreStatus"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from '../../lib/RcModule';\nimport moduleStatuses from '../../enums/moduleStatuses';\n\nimport { batchPutApi } from '../../lib/batchApiHelper';\n\nimport * as messageHelper from '../../lib/messageHelper';\nimport * as messageStoreHelper from './messageStoreHelper';\n\nimport actionTypes from './actionTypes';\nimport getMessageStoreReducer from './getMessageStoreReducer';\nimport getDataReducer from './getDataReducer';\nimport sleep from '../../lib/sleep';\n\nexport function processResponseData(data) {\n  const records = data.records.slice();\n  return {\n    records: records.reverse(),\n    syncTimestamp: (new Date(data.syncInfo.syncTime)).getTime(),\n    syncToken: data.syncInfo.syncToken,\n  };\n}\n\nexport default class MessageStore extends RcModule {\n  constructor({\n    alert,\n    client,\n    auth,\n    ttl = 30 * 60 * 1000,\n    storage,\n    subscription,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._alert = alert;\n    this._client = client;\n    this._storage = storage;\n    this._subscription = subscription;\n    this._reducer = getMessageStoreReducer(this.actionTypes);\n    this._ttl = ttl;\n    this._auth = auth;\n    this._promise = null;\n    this._lastSubscriptionMessage = null;\n    this._storageKey = 'messageStore';\n\n    this._storage.registerReducer({\n      key: this._storageKey,\n      reducer: getDataReducer(this.actionTypes),\n    });\n\n    this.addSelector(\n      'unreadCounts',\n      () => this.allConversations,\n      (conversations) => {\n        let unreadCounts = 0;\n        conversations.forEach((conversation) => {\n          if (messageHelper.messageIsTextMessage(conversation)) {\n            unreadCounts += conversation.unreadCounts;\n          }\n        });\n        return unreadCounts;\n      }\n    );\n\n    this.addSelector(\n      'textConversations',\n      () => this.allConversations,\n      conversations =>\n        conversations.filter(\n          conversation => messageHelper.messageIsTextMessage(conversation)\n        )\n    );\n\n    this.addSelector(\n      'faxMessages',\n      () => this.allConversations,\n      conversations =>\n        conversations.filter(\n          conversation => messageHelper.messageIsFax(conversation)\n        )\n    );\n\n    this.addSelector(\n      'voicemailMessages',\n      () => this.allConversations,\n      conversations =>\n        conversations.filter(\n          conversation => messageHelper.messageIsVoicemail(conversation)\n        )\n    );\n\n    this.syncConversation = this.syncConversation.bind(this);\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  _onStateChange() {\n    if (this._shouldInit()) {\n      this.store.dispatch({\n        type: this.actionTypes.init,\n      });\n      if (this._shouleCleanCache()) {\n        this._cleanUpCache();\n      }\n      this._initMessageStore();\n    } else if (this._shouldReset()) {\n      this._resetModuleStatus();\n    } else if (\n      this.ready\n    ) {\n      this._subscriptionHandler();\n    }\n  }\n\n  _shouldInit() {\n    return (\n      this._storage.ready &&\n      this._subscription.ready &&\n      this.pending\n    );\n  }\n\n  _shouldReset() {\n    return (\n      (\n        !this._storage.ready ||\n        !this._subscription.ready\n      ) &&\n      this.ready\n    );\n  }\n\n  _shouleCleanCache() {\n    return (\n      this._auth.isFreshLogin ||\n      (Date.now() - this.updatedTimestamp) > this._ttl\n    );\n  }\n\n  _resetModuleStatus() {\n    this.store.dispatch({\n      type: this.actionTypes.resetSuccess,\n    });\n  }\n\n  _cleanUpCache() {\n    this.store.dispatch({\n      type: this.actionTypes.cleanUp,\n    });\n  }\n\n  findConversationById(id) {\n    return this.conversationMap[id.toString()];\n  }\n\n  async _initMessageStore() {\n    try {\n      await this._syncMessages();\n      this._subscription.subscribe('/account/~/extension/~/message-store');\n    } catch (e) {\n      console.error(e);\n    }\n    this.store.dispatch({\n      type: this.actionTypes.initSuccess,\n    });\n  }\n\n  _subscriptionHandler() {\n    const accountExtesionEndPoint = /\\/message-store$/;\n    const message = this._subscription.message;\n    if (\n      message &&\n      message !== this._lastSubscriptionMessage &&\n      accountExtesionEndPoint.test(message.event) &&\n      message.body &&\n      message.body.changes\n    ) {\n      this._lastSubscriptionMessage = this._subscription.message;\n      this._syncMessages();\n    }\n  }\n\n  async _messageSyncApi(params) {\n    const response = await this._client.account()\n                             .extension()\n                             .messageSync()\n                             .list(params);\n    return response;\n  }\n  async _recursiveFSync({\n    dateFrom,\n    dateTo = null,\n    syncToken,\n    recordsLength = 0,\n  }) {\n    const MAX_MSG_LENGTH = 1000;\n    const params = messageStoreHelper.getMessageSyncParams({\n      dateFrom,\n      dateTo,\n      syncToken,\n    });\n    const response = await this._messageSyncApi(params);\n    const records = response.records;\n    recordsLength += records.length;\n    if (recordsLength > MAX_MSG_LENGTH || !response.syncInfo.olderRecordsExist) {\n      return {\n        records,\n        syncInfo: response.syncInfo\n      };\n    }\n    await sleep(1000);\n    const _dateTo = new Date(response.records[response.records.length - 1].creationTime);\n    const lastResponse = await this._recursiveFSync({\n      dateFrom,\n      dateTo: _dateTo,\n      syncToken,\n      recordsLength,\n    });\n    return {\n      records: records.concat(lastResponse.records),\n      syncInfo: response.syncInfo\n    };\n  }\n  async _updateMessagesFromSync() {\n    let response;\n    this.store.dispatch({\n      type: this.actionTypes.sync,\n    });\n    const oldSyncToken = this.syncToken;\n    const params = messageStoreHelper.getMessageSyncParams({ syncToken: oldSyncToken });\n    if (!oldSyncToken) {\n      response = await this._recursiveFSync({\n        ...params,\n      });\n    } else {\n      response = await this._messageSyncApi(params);\n    }\n    const {\n      records,\n      syncTimestamp,\n      syncToken,\n    } = processResponseData(response);\n    this.store.dispatch({\n      type: this.actionTypes.syncSuccess,\n      records,\n      syncTimestamp,\n      syncToken,\n    });\n  }\n\n  async _updateConversationFromSync(conversationId) {\n    let response;\n    const conversation = this.conversationMap[conversationId.toString()];\n    if (!conversation) {\n      return;\n    }\n    this.store.dispatch({\n      type: this.actionTypes.sync,\n    });\n    const oldSyncToken = conversation.syncToken;\n    const params = messageStoreHelper.getMessageSyncParams({\n      syncToken: oldSyncToken,\n      conversationId: conversation.id,\n    });\n    if (!oldSyncToken) {\n      response = await this._recursiveFSync({\n        ...params,\n      });\n    } else {\n      response = await this._messageSyncApi(params);\n    }\n    const {\n      records,\n      syncTimestamp,\n      syncToken,\n    } = processResponseData(response);\n    this.store.dispatch({\n      type: this.actionTypes.syncConversationSuccess,\n      records,\n      syncTimestamp,\n      syncToken,\n      syncConversationId: conversation.id,\n    });\n  }\n\n  async _syncMessages() {\n    await this._sync(async () => {\n      await this._updateMessagesFromSync();\n    });\n  }\n\n  async syncConversation(id) {\n    await this._sync(async () => {\n      await this._updateConversationFromSync(id);\n    });\n  }\n\n  async _sync(syncFunction) {\n    if (!this._promise) {\n      this._promise = (async () => {\n        try {\n          await syncFunction();\n          this._promise = null;\n        } catch (error) {\n          this._onSyncError();\n          this._promise = null;\n          throw error;\n        }\n      })();\n    }\n    await this._promise;\n  }\n\n  _onSyncError() {\n    this.store.dispatch({\n      type: this.actionTypes.syncError,\n    });\n  }\n\n  async _updateMessageApi(messageId, status) {\n    const body = {\n      readStatus: status,\n    };\n    const updateRequest = await this._client.account()\n                                            .extension()\n                                            .messageStore(messageId)\n                                            .put(body);\n    return updateRequest;\n  }\n\n  async _batchUpdateMessagesApi(messageIds, body) {\n    const ids = decodeURIComponent(messageIds.join(','));\n    const platform = this._client.service.platform();\n    const responses = await batchPutApi({\n      platform,\n      url: `/account/~/extension/~/message-store/${ids}`,\n      body,\n    });\n    return responses;\n  }\n\n  async _updateMessagesApi(messageIds, status) {\n    if (messageIds.length === 1) {\n      const result = await this._updateMessageApi(messageIds[0], status);\n      return [result];\n    }\n    const UPDATE_MESSAGE_ONCE_COUNT = 20;\n    const leftIds = messageIds.slice(0, UPDATE_MESSAGE_ONCE_COUNT);\n    const rightIds = messageIds.slice(UPDATE_MESSAGE_ONCE_COUNT);\n    const body = leftIds.map(() => (\n      { body: { readStatus: status } }\n    ));\n    const responses = await this._batchUpdateMessagesApi(leftIds, body);\n    const results = [];\n    responses.forEach((res) => {\n      if (res.response().status === 200) {\n        results.push(res.json());\n      }\n    });\n    if (rightIds.length > 0) {\n      const rightResults = await this._updateMessagesApi(rightIds, status);\n      if (rightResults.length > 0) {\n        results.concat(rightResults);\n      }\n    }\n    return results;\n  }\n\n  async readMessages(conversationId) {\n    const conversation = this.conversationMap[conversationId];\n    if (!conversation) {\n      return null;\n    }\n    const unreadMessageIds = Object.keys(conversation.unreadMessages);\n    if (unreadMessageIds.length === 0) {\n      return null;\n    }\n    try {\n      const updatedMessages = await this._updateMessagesApi(unreadMessageIds, 'Read');\n      this.store.dispatch({\n        type: this.actionTypes.updateMessages,\n        records: updatedMessages,\n      });\n    } catch (error) {\n      console.error(error);\n    }\n    return null;\n  }\n\n  searchMessagesText(searchText) {\n    return this.messages.filter((message) => {\n      if (\n        message.subject &&\n        message.subject.toLowerCase().indexOf(searchText) >= 0\n      ) {\n        return true;\n      }\n      return false;\n    });\n  }\n\n  updateConversationRecipientList(conversationId, recipients) {\n    this.store.dispatch({\n      type: this.actionTypes.updateConversationRecipients,\n      conversationId,\n      recipients,\n    });\n  }\n\n  pushMessages(records) {\n    this.store.dispatch({\n      type: this.actionTypes.updateMessages,\n      records,\n    });\n  }\n\n  pushMessage(record) {\n    this.pushMessages([record]);\n  }\n\n  get cache() {\n    return this._storage.getItem(this._storageKey);\n  }\n\n  get messages() {\n    return this.cache.data.messages;\n  }\n\n  get allConversations() {\n    return this.cache.data.conversations;\n  }\n\n  get voicemailMessages() {\n    return this._selectors.voicemailMessages();\n  }\n\n  get faxMessages() {\n    return this._selectors.faxMessages();\n  }\n\n  get conversations() {\n    return this._selectors.textConversations();\n  }\n\n  get conversationMap() {\n    return this.cache.data.conversationMap;\n  }\n\n  get updatedTimestamp() {\n    return this.cache.updatedTimestamp;\n  }\n\n  get syncTimestamp() {\n    return this.cache.data.syncTimestamp;\n  }\n\n  get syncToken() {\n    return this.cache.syncToken;\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get unreadCounts() {\n    return this._selectors.unreadCounts();\n  }\n\n  get messageStoreStatus() {\n    return this.state.messageStoreStatus;\n  }\n\n  get ready() {\n    return this.status === moduleStatuses.ready;\n  }\n\n  get pending() {\n    return this.status === moduleStatuses.pending;\n  }\n}\n"]}