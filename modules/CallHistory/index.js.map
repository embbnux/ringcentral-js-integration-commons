{"version":3,"sources":["modules/CallHistory/index.js"],"names":["CallHistory","accountInfo","callLog","callMonitor","activityMatcher","contactMatcher","options","actionTypes","_accountInfo","_callLog","_activityMatcher","_contactMatcher","_callMonitor","_reducer","addSelector","calls","countryCode","map","call","callFrom","from","phoneNumber","callTo","to","sort","_selectors","normalizedCalls","state","endedCalls","dataMapping","callMatched","contactMapping","activityMapping","sessionIds","sessionId","fromNumber","extensionNumber","toNumber","fromMatches","toMatches","activityMatches","matched","toNumberEntity","filter","output","numberMap","addIfNotExist","number","push","addNumbersFromCall","forEach","addQuerySource","getQueriesFn","uniqueNumbers","readyCheckFn","ready","concat","store","subscribe","_onStateChange","_shouldInit","_initModuleStatus","_shouldReset","_resetModuleStatus","_processCallHistory","pending","_lastProcessedNumbers","_lastProcessedIds","monitorCalls","callLogCalls","_lastProcessedMonitorCalls","find","currentCall","currentCalls","_lastProcessedCalls","ids","recentlyEndedCalls","_shouldTriggerContactMatch","triggerMatch","_shouldTriggerActivityMatch","_getEndedCalls","length","_addEndedCalls","shouldRemove","_shouldRemoveEndedCalls","_removeEndedCalls","dispatch","type","init","initSuccess","reset","resetSuccess","result","addEndedCalls","timestamp","Date","now","sync","removeEndedCalls","status"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from '../../lib/RcModule';\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport {\n  sortByStartTime,\n} from '../../lib/callLogHelpers';\nimport actionTypes from './actionTypes';\nimport getCallHistoryReducer from './getCallHistoryReducer';\nimport ensureExist from '../../lib/ensureExist';\nimport normalizeNumber from '../../lib/normalizeNumber';\n\nexport default class CallHistory extends RcModule {\n  constructor({\n    accountInfo,\n    callLog,\n    callMonitor,\n    activityMatcher,\n    contactMatcher,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._accountInfo = this::ensureExist(accountInfo, 'accountInfo');\n    this._callLog = this::ensureExist(callLog, 'callLog');\n    this._activityMatcher = activityMatcher;\n    this._contactMatcher = contactMatcher;\n    this._callMonitor = callMonitor;\n    this._reducer = getCallHistoryReducer(this.actionTypes);\n\n    this.addSelector('normalizedCalls',\n      () => this._callLog.calls,\n      () => this._accountInfo.countryCode,\n      (calls, countryCode) => (\n        calls.map((call) => {\n          const callFrom = {\n            ...call.from,\n          };\n          if (callFrom.phoneNumber) {\n            callFrom.phoneNumber = normalizeNumber({\n              phoneNumber: callFrom.phoneNumber,\n              countryCode,\n            });\n          }\n          const callTo = {\n            ...call.to,\n          };\n          if (callTo.phoneNumber) {\n            callTo.phoneNumber = normalizeNumber({\n              phoneNumber: callTo.phoneNumber,\n              countryCode,\n            });\n          }\n          return {\n            ...call,\n            from: callFrom,\n            to: callTo,\n          };\n        }).sort(sortByStartTime)\n      ),\n    );\n\n    this.addSelector('calls',\n      this._selectors.normalizedCalls,\n      () => this.state.endedCalls,\n      () => (this._contactMatcher && this._contactMatcher.dataMapping),\n      () => (this._activityMatcher && this._activityMatcher.dataMapping),\n      () => (this._callMonitor && this._callMonitor.callMatched),\n      (\n        normalizedCalls,\n        endedCalls,\n        contactMapping = {},\n        activityMapping = {},\n        callMatched = {}\n      ) => {\n        const sessionIds = {};\n        const calls = normalizedCalls.map((call) => {\n          sessionIds[call.sessionId] = true;\n          const fromNumber = call.from && (call.from.phoneNumber || call.from.extensionNumber);\n          const toNumber = call.to && (call.to.phoneNumber || call.to.extensionNumber);\n          const fromMatches = (fromNumber && contactMapping[fromNumber]) || [];\n          const toMatches = (toNumber && contactMapping[toNumber]) || [];\n          const activityMatches = (activityMapping[call.sessionId]) || [];\n          const matched = callMatched[call.sessionId];\n          return {\n            ...call,\n            fromMatches,\n            toMatches,\n            activityMatches,\n            toNumberEntity: matched,\n          };\n        });\n        return [\n          ...endedCalls.filter(call => !sessionIds[call.sessionId]),\n          ...calls\n        ];\n      },\n    );\n\n    this.addSelector('uniqueNumbers',\n      this._selectors.normalizedCalls,\n      () => this.state.endedCalls,\n      (normalizedCalls, endedCalls) => {\n        const output = [];\n        const numberMap = {};\n        function addIfNotExist(number) {\n          if (!numberMap[number]) {\n            output.push(number);\n            numberMap[number] = true;\n          }\n        }\n        function addNumbersFromCall(call) {\n          if (call.from && call.from.phoneNumber) {\n            addIfNotExist(call.from.phoneNumber);\n          } else if (call.from && call.from.extensionNumber) {\n            addIfNotExist(call.from.extensionNumber);\n          }\n          if (call.to && call.to.phoneNumber) {\n            addIfNotExist(call.to.phoneNumber);\n          } else if (call.to && call.to.extensionNumber) {\n            addIfNotExist(call.to.extensionNumber);\n          }\n        }\n        normalizedCalls.forEach(addNumbersFromCall);\n        endedCalls.forEach(addNumbersFromCall);\n        return output;\n      },\n    );\n\n    if (this._contactMatcher) {\n      this._contactMatcher.addQuerySource({\n        getQueriesFn: this._selectors.uniqueNumbers,\n        readyCheckFn: () => (\n          (!this._callMonitor || this._callMonitor.ready) &&\n          this._callLog.ready &&\n          this._accountInfo.ready\n        ),\n      });\n    }\n\n    this.addSelector('sessionIds',\n      () => this._callLog.calls,\n      () => this.state.endedCalls,\n      (calls, endedCalls) => {\n        const sessionIds = {};\n        return calls.map((call) => {\n          sessionIds[call.sessionId] = true;\n          return call.sessionId;\n        }).concat(\n          endedCalls\n            .filter(call => !sessionIds[call.sessionId])\n            .map(call => call.sessionId)\n          );\n      },\n    );\n\n    if (this._activityMatcher) {\n      this._activityMatcher.addQuerySource({\n        getQueriesFn: this._selectors.sessionIds,\n        readyCheckFn: () => (\n          (!this._callMonitor || this._callMonitor.ready) &&\n          this._callLog.ready\n        ),\n      });\n    }\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  async _onStateChange() {\n    if (this._shouldInit()) {\n      this._initModuleStatus();\n    } else if (this._shouldReset()) {\n      this._resetModuleStatus();\n    } else if (\n      this.ready\n    ) {\n      this._processCallHistory();\n    }\n  }\n\n  _shouldInit() {\n    return (\n      this._callLog.ready &&\n      (!this._callMonitor || this._callMonitor.ready) &&\n      this._accountInfo.ready &&\n      (!this._contactMatcher || this._contactMatcher.ready) &&\n      (!this._activityMatcher || this._activityMatcher.ready) &&\n      this.pending\n    );\n  }\n\n  _shouldReset() {\n    return (\n      (!this._callLog.ready ||\n        (this._callMonitor && !this._callMonitor.ready) ||\n        !this._accountInfo.ready ||\n        (this._contactMatcher && !this._contactMatcher.ready) ||\n        (this._activityMatcher && !this._activityMatcher.ready)\n      ) &&\n      this.ready\n    );\n  }\n\n  _shouldTriggerContactMatch(uniqueNumbers) {\n    if (this._lastProcessedNumbers !== uniqueNumbers) {\n      this._lastProcessedNumbers = uniqueNumbers;\n      if (this._contactMatcher && this._contactMatcher.ready) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  _shouldTriggerActivityMatch(sessionIds) {\n    if (this._lastProcessedIds !== sessionIds) {\n      this._lastProcessedIds = sessionIds;\n      if (this._activityMatcher && this._activityMatcher.ready) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  _getEndedCalls() {\n    if (this._callMonitor) {\n      const monitorCalls = this._callMonitor.calls;\n      const callLogCalls = this._callLog.calls;\n      if (this._lastProcessedMonitorCalls !== monitorCalls) {\n        const endedCalls = (this._lastProcessedMonitorCalls || [])\n          .filter(call => (\n            !monitorCalls.find(currentCall => call.sessionId === currentCall.sessionId) &&\n            // if the call's callLog has been fetch, skip\n            !callLogCalls.find(currentCall => call.sessionId === currentCall.sessionId)\n          ));\n        this._lastProcessedMonitorCalls = monitorCalls;\n        return endedCalls;\n      }\n    }\n    return null;\n  }\n\n  _shouldRemoveEndedCalls() {\n    const currentCalls = this._callLog.calls;\n    if (currentCalls !== this._lastProcessedCalls) {\n      this._lastProcessedCalls = currentCalls;\n      const ids = {};\n      currentCalls.forEach((call) => {\n        ids[call.sessionId] = true;\n      });\n      return this.recentlyEndedCalls.filter(call => ids[call.sessionId]);\n    }\n    return null;\n  }\n\n  _processCallHistory() {\n    const uniqueNumbers = this.uniqueNumbers;\n    if (this._shouldTriggerContactMatch(uniqueNumbers)) {\n      this._contactMatcher.triggerMatch();\n    }\n    const sessionIds = this.sessionIds;\n    if (this._shouldTriggerActivityMatch(sessionIds)) {\n      this._activityMatcher.triggerMatch();\n    }\n\n    const endedCalls = this._getEndedCalls();\n    if (endedCalls && endedCalls.length) {\n      this._addEndedCalls(endedCalls);\n    }\n\n    const shouldRemove = this._shouldRemoveEndedCalls();\n    if (shouldRemove && shouldRemove.length) {\n      this._removeEndedCalls(shouldRemove);\n    }\n  }\n\n  _initModuleStatus() {\n    this.store.dispatch({\n      type: this.actionTypes.init,\n    });\n    this.store.dispatch({\n      type: this.actionTypes.initSuccess,\n    });\n  }\n\n  _resetModuleStatus() {\n    this.store.dispatch({\n      type: this.actionTypes.reset,\n    });\n    this._lastProcessedCalls = null;\n    this._lastProcessedIds = null;\n    this._lastProcessedMonitorCalls = null;\n    this._lastProcessedNumbers = null;\n    this.store.dispatch({\n      type: this.actionTypes.resetSuccess,\n    });\n  }\n\n  _addEndedCalls(endedCalls) {\n    endedCalls.map((call) => {\n      call.result = 'Disconnected';\n      return call;\n    });\n    this.store.dispatch({\n      type: this.actionTypes.addEndedCalls,\n      endedCalls,\n      timestamp: Date.now(),\n    });\n    this._callLog.sync();\n  }\n\n  _removeEndedCalls(endedCalls) {\n    this.store.dispatch({\n      type: this.actionTypes.removeEndedCalls,\n      endedCalls,\n    });\n  }\n\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatuses.ready;\n  }\n\n  get pending() {\n    return this.state.status === moduleStatuses.pending;\n  }\n\n  get calls() {\n    return this._selectors.calls();\n  }\n\n  get uniqueNumbers() {\n    return this._selectors.uniqueNumbers();\n  }\n\n  get sessionIds() {\n    return this._selectors.sessionIds();\n  }\n\n  get recentlyEndedCalls() {\n    return this.state.endedCalls;\n  }\n}\n"]}