{"version":3,"sources":["modules/RecentCalls/index.js"],"names":["RecentCalls","client","callHistory","options","actionTypes","_client","_callHistory","_reducer","store","subscribe","_onStateChange","pending","ready","dispatch","type","initSuccess","resetSuccess","currentContact","calls","id","initLoad","_getRecentCalls","loadSuccess","contact","loadReset","daySpan","length","dateFrom","recentCalls","_getLocalRecentCalls","_fetchRemoteRecentCalls","toISOString","sort","_sortByTime","_dedup","slice","phoneNumbers","reduce","acc","call","to","from","matches","find","_filterPhoneNumber","Date","startTime","concat","phoneNumber","extensionNumber","params","perPage","recentCallsPromises","phoneType","replace","promise","_fetchCallLogList","then","_flattenToRecords","account","extension","callLog","list","items","records","a","b","hash","cur","state","callStatus","loaded","status"],"mappings":"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","file":"index.js","sourcesContent":["import proxify from '../../lib/proxy/proxify';\nimport RcModule from '../../lib/RcModule';\nimport actionTypes from './actionTypes';\nimport callStatus from './callStatus';\nimport getRecentCallsReducer from './getRecentCallsReducer';\nimport getDateFrom from '../../lib/getDateFrom';\nimport ensureExist from '../../lib/ensureExist';\nimport concurrentExecute from '../../lib/concurrentExecute';\n\n/**\n * @class\n * @description Retrieve all recent calls related to a specified contact.\n */\nexport default class RecentCalls extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {CallHistory} params.callHistory - callHistory module instance\n   * @param {Client} params.client - client module instance\n   */\n  constructor({\n    client,\n    callHistory,\n    ...options\n  }) {\n    super({\n      actionTypes,\n      ...options\n    });\n    this._client = this::ensureExist(client, 'client');\n    this._callHistory = this::ensureExist(callHistory, 'callHistory');\n    this._reducer = getRecentCallsReducer(this.actionTypes);\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  _onStateChange() {\n    if (\n      this.pending &&\n      this._callHistory.ready\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    } else if (\n      this.ready &&\n      !this._callHistory.ready\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.resetSuccess\n      });\n    }\n  }\n\n  get calls() {\n    return this.state.calls;\n  }\n\n  get isCallsLoaded() {\n    return this.state.callStatus === callStatus.loaded;\n  }\n\n  @proxify\n  async getCalls(currentContact) {\n    // No need to calculate recent calls of the same contact repeatly\n    if (!currentContact) {\n      return;\n    }\n    if (this.calls[currentContact.id]) {\n      return;\n    }\n    this.store.dispatch({\n      type: this.actionTypes.initLoad\n    });\n    const calls = await this._getRecentCalls(\n      currentContact,\n      this._callHistory.calls\n    );\n    this.store.dispatch({\n      type: this.actionTypes.loadSuccess,\n      calls,\n      contact: currentContact\n    });\n  }\n\n  cleanUpCalls(contact) {\n    this.store.dispatch({\n      type: this.actionTypes.loadReset,\n      contact\n    });\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  /**\n   * Searching for recent calls of specific contact.\n   * @param {Object} currentContact Current contact\n   * @param {Array} calls Calls in callHistory\n   * @param {Number} daySpan Find calls within certain days\n   * @param {Number} length Maximum length of recent calls\n   * @return {Array}\n   * @private\n   */\n  async _getRecentCalls(currentContact, calls = [], daySpan = 60, length = 5) {\n    const dateFrom = getDateFrom(daySpan);\n    let recentCalls = this._getLocalRecentCalls(\n      currentContact,\n      calls,\n      dateFrom\n    );\n\n    // If we could not find enough recent calls,\n    // we need to search for calls on server.\n    if (recentCalls.length < length) {\n      recentCalls = await this._fetchRemoteRecentCalls(\n        currentContact,\n        dateFrom.toISOString(),\n        length\n      );\n    }\n\n    recentCalls.sort(this._sortByTime);\n    recentCalls = this._dedup(recentCalls);\n    return recentCalls.length > length\n      ? recentCalls.slice(0, length)\n      : recentCalls;\n  }\n\n  /**\n   * Get recent calls from callHistory.\n   * @param {Object} currentContact\n   * @param {Array} calls\n   * @param {Date} dateFrom\n   */\n  _getLocalRecentCalls(currentContact, calls, dateFrom) {\n    // Get all calls related to this contact\n    const phoneNumbers = currentContact.phoneNumbers;\n    return calls.reduce((acc, call) => {\n      if (call && call.to && call.from) {\n        const matches = phoneNumbers.find(this._filterPhoneNumber(call));\n\n        // Check if calls is within certain days\n        if (!!matches && new Date(call.startTime) > dateFrom) {\n          return acc.concat(call);\n        }\n      }\n      return acc;\n    }, []);\n  }\n\n  _filterPhoneNumber(call) {\n    return ({ phoneNumber }) => (\n      phoneNumber === call.from.phoneNumber ||\n      phoneNumber === call.to.phoneNumber ||\n      phoneNumber === call.from.extensionNumber ||\n      phoneNumber === call.to.extensionNumber\n    );\n  }\n\n  /**\n   * Fetch recent calls from server by given current contact.\n   * @param {Object} currentContact\n   * @param {String} dateFrom\n   * @param {String} dateTo\n   * @param {Number} length The number of calls\n   * @return {Array}\n   */\n  _fetchRemoteRecentCalls(\n    currentContact,\n    dateFrom,\n    length\n  ) {\n    const params = {\n      dateFrom,\n      perPage: length,\n      type: 'Voice'\n    };\n\n    // CallLog API doesn't support plus sign in phoneNumber\n    const phoneNumbers = currentContact.phoneNumbers;\n    const recentCallsPromises = phoneNumbers.reduce((acc, { phoneType, phoneNumber }) => {\n      phoneNumber = phoneNumber.replace('+', '');\n      if (phoneType === 'extension') {\n        const promise = this._fetchCallLogList(\n          Object.assign({}, params, {\n            extensionNumber: phoneNumber\n          })\n        );\n        return acc.concat(promise);\n      }\n      const promise = this._fetchCallLogList(\n        Object.assign({}, params, {\n          phoneNumber\n        })\n      );\n      return acc.concat(promise);\n    }, []);\n\n    return concurrentExecute(recentCallsPromises, 5, 500)\n      .then(this._flattenToRecords);\n  }\n\n  _fetchCallLogList(params) {\n    return () => this._client.account().extension().callLog().list(params);\n  }\n\n  _flattenToRecords(items) {\n    return items.reduce((acc, { records }) => acc.concat(records), []);\n  }\n\n  // Sort by time in descending order\n  _sortByTime(a, b) {\n    return new Date(b.startTime) - new Date(a.startTime);\n  }\n\n  _dedup(calls) {\n    const hash = {};\n    return calls.reduce((acc, cur) => {\n      if (hash[cur.id]) return acc;\n      hash[cur.id] = true;\n      return acc.concat(cur);\n    }, []);\n  }\n}\n"]}