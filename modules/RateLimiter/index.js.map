{"version":3,"sources":["modules/RateLimiter/index.js"],"names":["DEFAULT_THROTTLE_DURATION","RateLimiter","alert","client","environment","globalStorage","throttleDuration","options","actionTypes","_beforeRequestHandler","throttling","Error","rateLimitReached","_checkTimestamp","store","dispatch","type","stopThrottle","_requestErrorHandler","apiResponse","message","wasThrottling","startThrottle","timestamp","Date","now","showAlert","setTimeout","_throttleDuration","_alert","_client","_environment","_storage","_storageKey","_reducer","registerReducer","key","reducer","_timeoutId","subscribe","ready","_bindHandlers","initSuccess","changed","danger","ttl","allowDuplicates","_unbindHandlers","service","platform","on","events","requestError","beforeRequest","removeListener","state","status","getItem"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from '../../lib/RcModule';\nimport actionTypes from './actionTypes';\nimport moduleStatus from '../../enums/moduleStatus';\nimport getRateLimiterReducer, {\n  getTimestampReducer,\n} from './getRateLimiterReducer';\nimport errorMessages from './errorMessages';\n\nconst DEFAULT_THROTTLE_DURATION = 61 * 1000;\n\nexport default class RateLimiter extends RcModule {\n  constructor({\n    alert,\n    client,\n    environment,\n    globalStorage,\n    throttleDuration = DEFAULT_THROTTLE_DURATION,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._alert = alert;\n    this._client = client;\n    this._environment = environment;\n    this._storage = globalStorage;\n    this._throttleDuration = throttleDuration;\n    this._storageKey = 'rateLimiterTimestamp';\n    this._reducer = getRateLimiterReducer(this.actionTypes);\n    this._storage.registerReducer({\n      key: this._storageKey,\n      reducer: getTimestampReducer(this.actionTypes),\n    });\n    this._timeoutId = null;\n  }\n  initialize() {\n    this.store.subscribe(async () => {\n      if (\n        !this.ready &&\n        this._storage.ready &&\n        (!this._environment || this._environment.ready)\n      ) {\n        this._bindHandlers();\n        this.store.dispatch({\n          type: this.actionTypes.initSuccess,\n        });\n      } else if (\n        this.ready &&\n        this._environment && this._environment.changed\n      ) {\n        this._bindHandlers();\n      }\n    });\n  }\n  _beforeRequestHandler = () => {\n    if (this.throttling) {\n      throw new Error(errorMessages.rateLimitReached);\n    }\n  }\n  _checkTimestamp = () => {\n    if (!this.throttling) {\n      this.store.dispatch({\n        type: this.actionTypes.stopThrottle,\n      });\n    }\n  }\n  showAlert() {\n    if (this.throttling && this._alert) {\n      this._alert.danger({\n        message: errorMessages.rateLimitReached,\n        ttl: this.ttl,\n        allowDuplicates: false,\n      });\n    }\n  }\n  _requestErrorHandler = (apiResponse) => {\n    if (\n      apiResponse instanceof Error &&\n      apiResponse.message === 'Request rate exceeded'\n    ) {\n      const wasThrottling = this.throttling;\n      this.store.dispatch({\n        type: this.actionTypes.startThrottle,\n        timestamp: Date.now(),\n      });\n      if (!wasThrottling) {\n        this.showAlert();\n      }\n      setTimeout(this._checkTimestamp, this._throttleDuration);\n    }\n  }\n  _bindHandlers() {\n    if (this._unbindHandlers) {\n      this._unbindHandlers();\n    }\n    const client = this._client.service.platform().client();\n    client.on(client.events.requestError, this._requestErrorHandler);\n    client.on(client.events.beforeRequest, this._beforeRequestHandler);\n    this._unbindHandlers = () => {\n      client.removeListener(client.events.requestError, this._requestErrorHandler);\n      client.removeListener(client.events.beforeRequest, this._beforeRequestHandler);\n      this._unbindHandlers = null;\n    };\n  }\n\n  get ttl() {\n    return this.throttling ? this._throttleDuration - (Date.now() - this.timestamp) : 0;\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get timestamp() {\n    return this._storage.getItem(this._storageKey);\n  }\n\n  get throttleDuration() {\n    return this._throttleDuration;\n  }\n\n  get throttling() {\n    return Date.now() - this._storage.getItem(this._storageKey) <= this._throttleDuration;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatus.ready;\n  }\n}\n"]}