{"version":3,"sources":["modules/Messages/index.js"],"names":["Messages","messageStore","perPage","contactMatcher","options","actionTypes","_contactMatcher","_messageStore","_perPage","_reducer","loadNextPageMessages","bind","updateSearchingString","updateSearchResults","addSelector","messages","ready","dataMapping","map","message","from","to","recipients","fromUser","toUsers","fromNumber","phoneNumber","extensionNumber","matchedNames","addMatchedNamesToRecipients","recipient","number","conversations","output","numberMap","addIfNotExist","push","forEach","length","toUser","addQuerySource","getQueriesFn","_selectors","uniqueNumbers","readyCheckFn","store","subscribe","_onStateChange","_shouldInit","dispatch","type","init","_initMessages","initSuccess","_shouldReset","_resetModuleStatus","_shouldReload","_reloadMessages","pending","messageStoreUpdatedAt","updatedTimestamp","_getCurrnetPageMessages","resetPage","_updateMessages","resetSuccess","page","currentPage","allMessages","bottomIndex","newMessages","slice","reverse","updateMessages","messagesTimestamp","maxIndex","topIndex","pushMessages","nextPage","searchingString","searchResults","state","status","lastUpdatedAt","searchingResults","normalizedMessages"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from '../../lib/RcModule';\nimport moduleStatuses from '../../enums/moduleStatuses';\n\nimport actionTypes from './actionTypes';\nimport getMessagesReducer from './getMessagesReducer';\n\nexport default class Messages extends RcModule {\n  constructor({\n    messageStore,\n    perPage = 20,\n    contactMatcher,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._contactMatcher = contactMatcher;\n    this._messageStore = messageStore;\n    this._perPage = perPage;\n    this._reducer = getMessagesReducer(this.actionTypes);\n    this.loadNextPageMessages = this.loadNextPageMessages.bind(this);\n    this.updateSearchingString = this.updateSearchingString.bind(this);\n    this.updateSearchResults = this.updateSearchResults.bind(this);\n\n    this.addSelector('normalizedMessages',\n      () => this.messages,\n      () => (this._contactMatcher && this._contactMatcher.ready ?\n        this._contactMatcher.dataMapping :\n        null),\n      (messages, dataMapping) => messages.map((message) => {\n        if (!dataMapping || !message.from || !message.to) {\n          return message;\n        }\n        let recipients = message.recipients;\n        const fromUser = { ...message.from };\n        let toUsers = message.to;\n        const fromNumber = fromUser.phoneNumber || fromUser.extensionNumber;\n        fromUser.matchedNames = dataMapping[fromNumber];\n        const addMatchedNamesToRecipients = (recipient) => {\n          const number = recipient.phoneNumber || recipient.extensionNumber;\n          return {\n            ...recipient,\n            matchedNames: dataMapping[number]\n          };\n        };\n        toUsers = toUsers.map(addMatchedNamesToRecipients);\n        if (recipients) {\n          recipients = recipients.map(addMatchedNamesToRecipients);\n        }\n        return {\n          ...message,\n          from: fromUser,\n          to: toUsers,\n          recipients,\n        };\n      })\n    );\n\n    this.addSelector('uniqueNumbers',\n      () => this._messageStore.conversations,\n      (messages) => {\n        const output = [];\n        const numberMap = {};\n        function addIfNotExist(number) {\n          if (!numberMap[number]) {\n            output.push(number);\n            numberMap[number] = true;\n          }\n        }\n        messages.forEach((message) => {\n          if (message.from && message.from.phoneNumber) {\n            addIfNotExist(message.from.phoneNumber);\n          } else if (message.from && message.from.extensionNumber) {\n            addIfNotExist(message.from.extensionNumber);\n          }\n          if (message.to && message.to.length > 0) {\n            message.to.forEach((toUser) => {\n              if (toUser && toUser.phoneNumber) {\n                addIfNotExist(toUser.phoneNumber);\n              } else if (toUser && toUser.extensionNumber) {\n                addIfNotExist(toUser.extensionNumber);\n              }\n            });\n          }\n        });\n        return output;\n      },\n    );\n\n    if (this._contactMatcher) {\n      this._contactMatcher.addQuerySource({\n        getQueriesFn: this._selectors.uniqueNumbers,\n        readyCheckFn: () => (\n          this._messageStore.ready\n        ),\n      });\n    }\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  _onStateChange() {\n    if (this._shouldInit()) {\n      this.store.dispatch({\n        type: this.actionTypes.init,\n      });\n      this._initMessages();\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    } else if (this._shouldReset()) {\n      this._resetModuleStatus();\n    } else if (this._shouldReload()) {\n      this._reloadMessages();\n    }\n  }\n\n  _shouldInit() {\n    return (\n      this._messageStore.ready &&\n      this.pending\n    );\n  }\n\n  _shouldReset() {\n    return (\n      (!this._messageStore.ready) &&\n      this.ready\n    );\n  }\n\n  _shouldReload() {\n    return (\n      this.ready &&\n      this.messageStoreUpdatedAt !== this._messageStore.updatedTimestamp\n    );\n  }\n\n  _initMessages() {\n    const messages = this._getCurrnetPageMessages(1);\n    this.store.dispatch({\n      type: this.actionTypes.resetPage,\n    });\n    this._updateMessages(messages);\n  }\n\n  _resetModuleStatus() {\n    this.store.dispatch({\n      type: this.actionTypes.resetSuccess,\n    });\n  }\n\n  _reloadMessages() {\n    const page = this.currentPage;\n    const allMessages = this._messageStore.conversations;\n    let bottomIndex = allMessages.length - (this._perPage * page);\n    if (bottomIndex < 0) {\n      bottomIndex = 0;\n    }\n    const newMessages = allMessages.slice(bottomIndex, allMessages.length).reverse();\n    this._updateMessages(newMessages);\n  }\n\n  _updateMessages(messages) {\n    this.store.dispatch({\n      type: this.actionTypes.updateMessages,\n      messagesTimestamp: this._messageStore.updatedTimestamp,\n      messages,\n    });\n  }\n\n  _getCurrnetPageMessages(page) {\n    const allMessages = this._messageStore.conversations;\n    const maxIndex = allMessages.length - 1;\n    if (maxIndex < 0) {\n      return [];\n    }\n    if (page < 1) {\n      page = 1;\n    }\n    const topIndex = maxIndex - (this._perPage * (page - 1));\n    if (topIndex < 0) {\n      return [];\n    }\n    let bottomIndex = (topIndex - this._perPage) + 1;\n    if (bottomIndex < 0) {\n      bottomIndex = 0;\n    }\n    return allMessages.slice(bottomIndex, topIndex + 1).reverse();\n  }\n\n  loadNextPageMessages() {\n    const page = this.currentPage + 1;\n    const messages = this._getCurrnetPageMessages(page);\n    if (messages.length === 0) {\n      return;\n    }\n    this.store.dispatch({\n      type: this.actionTypes.pushMessages,\n      messagesTimestamp: this._messageStore.updatedTimestamp,\n      messages,\n    });\n    this.store.dispatch({\n      type: this.actionTypes.nextPage,\n    });\n  }\n\n  updateSearchingString(searchingString) {\n    this.store.dispatch({\n      type: this.actionTypes.updateSearchingString,\n      searchingString,\n    });\n  }\n\n  updateSearchResults(searchResults) {\n    this.store.dispatch({\n      type: this.actionTypes.updateSearchResults,\n      searchResults,\n    });\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.status === moduleStatuses.ready;\n  }\n\n  get pending() {\n    return this.status === moduleStatuses.pending;\n  }\n\n  get messages() {\n    return this.state.messages;\n  }\n\n  get currentPage() {\n    return this.state.currentPage;\n  }\n\n  get loading() {\n    const allMessages = this._messageStore.conversations;\n    return this.messages.length < allMessages.length;\n  }\n\n  get lastUpdatedAt() {\n    return this.state.lastUpdatedAt;\n  }\n\n  get messageStoreUpdatedAt() {\n    return this.state.messageStoreUpdatedAt;\n  }\n\n  get searchingString() {\n    return this.state.searchingString;\n  }\n\n  get searchingResults() {\n    return this.state.searchingResults;\n  }\n\n  get normalizedMessages() {\n    return this._selectors.normalizedMessages();\n  }\n}\n"]}