{"version":3,"sources":["modules/Messages/index.js"],"names":["Messages","messageStore","perPage","options","actionTypes","_messageStore","_perPage","_reducer","loadNextPageMessages","bind","updateSearchingString","updateSearchResults","store","subscribe","_onStateChange","_shouldInit","dispatch","type","init","_initMessages","initSuccess","_shouldReset","_resetModuleStatus","_shouldReload","_reloadMessages","ready","pending","messageStoreUpdatedAt","updatedTimestamp","messages","_getCurrnetPageMessages","resetPage","_updateMessages","resetSuccess","page","currentPage","allMessages","conversations","bottomIndex","length","newMessages","slice","reverse","updateMessages","messagesTimestamp","maxIndex","topIndex","pushMessages","nextPage","searchingString","searchResults","state","status","lastUpdatedAt","searchingResults"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from '../../lib/RcModule';\nimport moduleStatus from '../../enums/moduleStatus';\n\nimport actionTypes from './actionTypes';\nimport getMessagesReducer from './getMessagesReducer';\n\nexport default class Messages extends RcModule {\n  constructor({\n    messageStore,\n    perPage = 10,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._messageStore = messageStore;\n    this._perPage = perPage;\n    this._reducer = getMessagesReducer(this.actionTypes);\n    this.loadNextPageMessages = this.loadNextPageMessages.bind(this);\n    this.updateSearchingString = this.updateSearchingString.bind(this);\n    this.updateSearchResults = this.updateSearchResults.bind(this);\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  _onStateChange() {\n    if (this._shouldInit()) {\n      this.store.dispatch({\n        type: this.actionTypes.init,\n      });\n      this._initMessages();\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    } else if (this._shouldReset()) {\n      this._resetModuleStatus();\n    } else if (this._shouldReload()) {\n      this._reloadMessages();\n    }\n  }\n\n  _shouldInit() {\n    return (\n      this._messageStore.ready &&\n      this.pending\n    );\n  }\n\n  _shouldReset() {\n    return (\n      (!this._messageStore.ready) &&\n      this.ready\n    );\n  }\n\n  _shouldReload() {\n    return (\n      this.ready &&\n      this.messageStoreUpdatedAt !== this._messageStore.updatedTimestamp\n    );\n  }\n\n  _initMessages() {\n    const messages = this._getCurrnetPageMessages(1);\n    this.store.dispatch({\n      type: this.actionTypes.resetPage,\n    });\n    this._updateMessages(messages);\n  }\n\n  _resetModuleStatus() {\n    this.store.dispatch({\n      type: this.actionTypes.resetSuccess,\n    });\n  }\n\n  _reloadMessages() {\n    const page = this.currentPage;\n    const allMessages = this._messageStore.conversations;\n    let bottomIndex = allMessages.length - (this._perPage * page);\n    if (bottomIndex < 0) {\n      bottomIndex = 0;\n    }\n    const newMessages = allMessages.slice(bottomIndex, allMessages.length).reverse();\n    this._updateMessages(newMessages);\n  }\n\n  _updateMessages(messages) {\n    this.store.dispatch({\n      type: this.actionTypes.updateMessages,\n      messagesTimestamp: this._messageStore.updatedTimestamp,\n      messages,\n    });\n  }\n\n  _getCurrnetPageMessages(page) {\n    const allMessages = this._messageStore.conversations;\n    const maxIndex = allMessages.length - 1;\n    if (maxIndex < 0) {\n      return [];\n    }\n    if (page < 1) {\n      page = 1;\n    }\n    const topIndex = maxIndex - (this._perPage * (page - 1));\n    if (topIndex < 0) {\n      return [];\n    }\n    let bottomIndex = (topIndex - this._perPage) + 1;\n    if (bottomIndex < 0) {\n      bottomIndex = 0;\n    }\n    return allMessages.slice(bottomIndex, topIndex + 1).reverse();\n  }\n\n  loadNextPageMessages() {\n    const page = this.currentPage + 1;\n    const messages = this._getCurrnetPageMessages(page);\n    if (messages.length === 0) {\n      return;\n    }\n    this.store.dispatch({\n      type: this.actionTypes.pushMessages,\n      messagesTimestamp: this._messageStore.updatedTimestamp,\n      messages,\n    });\n    this.store.dispatch({\n      type: this.actionTypes.nextPage,\n    });\n  }\n\n  updateSearchingString(searchingString) {\n    this.store.dispatch({\n      type: this.actionTypes.updateSearchingString,\n      searchingString,\n    });\n  }\n\n  updateSearchResults(searchResults) {\n    this.store.dispatch({\n      type: this.actionTypes.updateSearchResults,\n      searchResults,\n    });\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.status === moduleStatus.ready;\n  }\n\n  get pending() {\n    return this.status === moduleStatus.pending;\n  }\n\n  get messages() {\n    return this.state.messages;\n  }\n\n  get currentPage() {\n    return this.state.currentPage;\n  }\n\n  get loading() {\n    const allMessages = this._messageStore.conversations;\n    return this.messages.length < allMessages.length;\n  }\n\n  get lastUpdatedAt() {\n    return this.state.lastUpdatedAt;\n  }\n\n  get messageStoreUpdatedAt() {\n    return this.state.messageStoreUpdatedAt;\n  }\n\n  get searchingString() {\n    return this.state.searchingString;\n  }\n\n  get searchingResults() {\n    return this.state.searchingResults;\n  }\n}\n"]}